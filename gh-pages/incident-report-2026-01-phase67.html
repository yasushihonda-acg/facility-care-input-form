<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>障害報告: 在庫キャッシュ同期問題 (Phase 67) - 施設ケア入力フォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .mermaid {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            background: #3b82f6;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-orange-600 to-yellow-600 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-4xl">&#x26A0;&#xFE0F;</span>
                <h1 class="text-3xl md:text-4xl font-bold">障害報告書</h1>
            </div>
            <p class="text-lg text-orange-100">在庫キャッシュ同期問題 - 2026年1月26日発生（Phase 67）</p>
            <div class="mt-4 flex gap-4">
                <a href="index.html" class="text-orange-200 hover:text-white text-sm flex items-center gap-1">
                    ← プロジェクト概要に戻る
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- サマリーカード -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4CB;</span> 概要
            </h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-red-50 rounded-lg p-4">
                    <p class="text-sm text-red-600 font-medium">発生日時</p>
                    <p class="text-lg font-bold text-red-800">2026年1月26日 17:04〜17:07</p>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <p class="text-sm text-orange-600 font-medium">影響</p>
                    <p class="text-lg font-bold text-orange-800">3件の無効な記録が発生</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-blue-600 font-medium">ステータス</p>
                    <p class="text-lg font-bold text-blue-800">&#x2705; 解決済み</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-green-600 font-medium">修正リリース</p>
                    <p class="text-lg font-bold text-green-800">2026年1月26日（PR #267）</p>
                </div>
            </div>
        </div>

        <!-- 何が起きたか -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4A5;</span> 何が起きたか
            </h2>
            <div class="prose max-w-none">
                <p class="text-gray-700 mb-4">
                    複数のスタッフが同時に水分記録を入力する際、<strong class="text-red-600">在庫切れの品物に対して記録が可能</strong>な問題が発生しました。
                </p>

                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-gray-800 mb-2">発生した状況</h3>
                    <ul class="space-y-2">
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 bg-green-500 rounded-full mt-2"></span>
                            <span><strong>16:51</strong> - 川原さんが水分記録を入力（残量1 → 0に消費）<span class="text-green-600">✓ 正常</span></span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full mt-2"></span>
                            <span><strong>17:04</strong> - 永橋さんが同じ品物に記録を試行<span class="text-red-600">✗ 在庫0なのに記録ボタンが表示</span></span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full mt-2"></span>
                            <span><strong>17:05</strong> - 永橋さんが再度記録を試行<span class="text-red-600">✗ 同上</span></span>
                        </li>
                        <li class="flex items-start gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full mt-2"></span>
                            <span><strong>17:06</strong> - 永橋さんが再度記録を試行<span class="text-red-600">✗ 同上</span></span>
                        </li>
                    </ul>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <p class="text-yellow-800">
                        <strong>結果:</strong> スプレッドシートには記録されたが、Firestoreの消費ログには「在庫不足」エラーで記録されず、UIに表示されない「ゴースト記録」が発生しました。
                    </p>
                </div>
            </div>
        </section>

        <!-- 原因分析 -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F50D;</span> 原因分析
            </h2>

            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-3">問題の構造</h3>
                <div class="mermaid">
sequenceDiagram
    participant A as 川原さんの端末
    participant B as 永橋さんの端末
    participant API as バックエンドAPI
    participant FS as Firestore
    participant SS as スプレッドシート

    Note over A,B: 両端末とも品物一覧をキャッシュ済み（残量=1）

    A->>API: 16:51 水分記録
    API->>FS: 消費ログ保存 ✓
    API->>SS: シート書込 ✓
    API->>FS: 残量更新 (1→0)
    API-->>A: 成功

    Note over B: キャッシュ未更新（残量=1のまま）
    Note over B: 記録ボタンが表示されたまま

    B->>API: 17:04 水分記録
    API->>SS: シート書込 ✓（在庫チェックなし）
    API->>FS: 消費ログ保存
    FS-->>API: ✗ 在庫不足エラー
    API-->>B: 部分的成功（シートのみ）

    Note over B: UIにはエラー表示されず
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">&#x274C; 問題点1: キャッシュ未同期</h4>
                    <p class="text-red-700 text-sm">
                        React Queryのキャッシュが他端末の更新を反映しないため、在庫0の品物に記録ボタンが表示され続けた
                    </p>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">&#x274C; 問題点2: フロントエンド在庫チェックなし</h4>
                    <p class="text-red-700 text-sm">
                        記録ボタン押下時に最新の在庫を確認せず、古いキャッシュデータのままダイアログを開いていた
                    </p>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <h4 class="font-bold text-orange-800 mb-2">&#x26A0;&#xFE0F; 背景: 二重書込アーキテクチャ</h4>
                    <p class="text-orange-700 text-sm">
                        スプレッドシートAPIは在庫チェックなし、FirestoreAPIは在庫チェックあり。両者の整合性が担保されていなかった
                    </p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <h4 class="font-bold text-blue-800 mb-2">&#x1F4A1; 制約: アーキテクチャ変更不可</h4>
                    <p class="text-blue-700 text-sm">
                        スプレッドシートとFirestoreの二重書込は業務要件のため変更不可。フロントエンドで対策が必要
                    </p>
                </div>
            </div>
        </section>

        <!-- 修正内容 -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F527;</span> 修正内容（Phase 67）
            </h2>

            <div class="space-y-4">
                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-bold text-gray-800">1. 自動リフレッシュの追加</h3>
                    <p class="text-gray-600 text-sm mt-1">
                        <code class="bg-gray-100 px-2 py-0.5 rounded">useCareItems</code> フックに30秒ごとの自動更新を追加。他スタッフの記録がUIに反映されるようになった。
                    </p>
                    <div class="bg-gray-50 rounded p-3 mt-2 text-sm font-mono">
                        refetchInterval: isDemo ? false : 30 * 1000
                    </div>
                </div>

                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-bold text-gray-800">2. 記録ボタン押下時の在庫チェック</h3>
                    <p class="text-gray-600 text-sm mt-1">
                        「提供記録」ボタンをクリックした際、APIで最新の品物データを取得し、在庫が0以下なら記録を拒否してエラーメッセージを表示。
                    </p>
                    <div class="bg-gray-50 rounded p-3 mt-2 text-sm">
                        <ul class="space-y-1">
                            <li>&#x2022; 最新データをAPIから取得</li>
                            <li>&#x2022; 在庫チェック（数量管理対象の場合）</li>
                            <li>&#x2022; 在庫切れならtoastエラー + リスト再取得</li>
                            <li>&#x2022; ローディングスピナー表示でUX改善</li>
                        </ul>
                    </div>
                </div>

                <div class="border-l-4 border-green-500 pl-4">
                    <h3 class="font-bold text-gray-800">3. 適用箇所</h3>
                    <div class="bg-gray-50 rounded p-3 mt-2 text-sm">
                        <ul class="space-y-1">
                            <li>&#x2022; <code>ItemBasedSnackRecord.tsx</code> - 間食記録一覧画面</li>
                            <li>&#x2022; <code>FamilyMessageDetail.tsx</code> - 品物詳細画面</li>
                        </ul>
                    </div>
                </div>
            </div>
        </section>

        <!-- 修正後のフロー -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x2705;</span> 修正後のフロー
            </h2>

            <div class="mermaid">
sequenceDiagram
    participant U as スタッフ端末
    participant FE as フロントエンド
    participant API as バックエンドAPI
    participant FS as Firestore

    Note over FE: 30秒ごとに自動リフレッシュ

    U->>FE: 記録ボタンクリック
    FE->>FE: ローディング表示開始
    FE->>API: getCareItem(itemId)
    API->>FS: 最新データ取得
    FS-->>API: 品物データ（残量=0）
    API-->>FE: 品物データ

    alt 在庫あり
        FE->>FE: 記録ダイアログを開く
    else 在庫なし
        FE->>U: ❌ エラーtoast表示
        FE->>FE: 品物一覧を再取得
        Note over U: 記録ボタンが非表示になる
    end
            </div>
        </section>

        <!-- 再発防止策 -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F6E1;&#xFE0F;</span> 再発防止策
            </h2>

            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">実装済</span>
                    <div>
                        <p class="font-medium text-gray-800">定期的なキャッシュ更新</p>
                        <p class="text-gray-600 text-sm">30秒間隔で品物一覧を自動リフレッシュ</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="bg-green-100 text-green-800 px-2 py-1 rounded text-sm font-medium">実装済</span>
                    <div>
                        <p class="font-medium text-gray-800">楽観的ロックの代替（フロントエンド在庫チェック）</p>
                        <p class="text-gray-600 text-sm">操作直前に最新データを取得し、在庫を確認</p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm font-medium">将来検討</span>
                    <div>
                        <p class="font-medium text-gray-800">リアルタイム同期（WebSocket/Firestore onSnapshot）</p>
                        <p class="text-gray-600 text-sm">より即時性の高い同期が必要な場合に検討</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 関連リンク -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F517;</span> 関連リンク
            </h2>
            <ul class="space-y-2">
                <li>
                    <a href="https://github.com/yasushihonda-acg/facility-care-input-form/pull/267" target="_blank" class="text-blue-600 hover:underline flex items-center gap-2">
                        <span>&#x1F4DD;</span> PR #267: fix: 在庫チェックを記録ボタン押下時に実施（Phase 67）
                    </a>
                </li>
                <li>
                    <a href="index.html" class="text-blue-600 hover:underline flex items-center gap-2">
                        <span>&#x1F3E0;</span> プロジェクト概要
                    </a>
                </li>
                <li>
                    <a href="incident-report-2026-01.html" class="text-blue-600 hover:underline flex items-center gap-2">
                        <span>&#x26A0;&#xFE0F;</span> 過去の障害報告: 重複登録問題（2026年1月）
                    </a>
                </li>
            </ul>
        </section>

        <!-- タイムライン -->
        <section class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4C5;</span> 対応タイムライン
            </h2>
            <div class="relative border-l-2 border-gray-200 ml-4 pl-8 space-y-6">
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 16:51</p>
                    <p class="font-medium text-gray-800">川原さんが水分記録を入力（正常動作）</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 17:04〜17:07</p>
                    <p class="font-medium text-red-600">永橋さんが在庫切れ品物に3回記録を試行（問題発生）</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 17:30</p>
                    <p class="font-medium text-gray-800">問題の報告・調査開始</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 18:00</p>
                    <p class="font-medium text-gray-800">原因特定（キャッシュ未同期 + フロントエンド在庫チェック欠如）</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 19:00</p>
                    <p class="font-medium text-gray-800">修正実装完了・PR #267 作成</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026-01-26 19:30</p>
                    <p class="font-medium text-green-600">PR #267 マージ・本番デプロイ完了</p>
                </div>
            </div>
        </section>

    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mt-12">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>施設ケア入力フォーム - 障害報告書（Phase 67）</p>
            <p class="mt-1">作成日: 2026年1月26日</p>
        </div>
    </footer>

    <script>
        mermaid.initialize({ startOnLoad: true, theme: 'default' });
    </script>
</body>
</html>
