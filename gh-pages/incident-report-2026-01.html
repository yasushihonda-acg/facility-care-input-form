<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>障害報告: 重複登録問題 (2026年1月) - 施設ケア入力フォーム</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <style>
        .mermaid {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -1.5rem;
            top: 0.5rem;
            width: 0.75rem;
            height: 0.75rem;
            background: #3b82f6;
            border-radius: 50%;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-gradient-to-r from-red-600 to-orange-600 text-white py-8">
        <div class="container mx-auto px-4">
            <div class="flex items-center gap-3 mb-2">
                <span class="text-4xl">&#x26A0;&#xFE0F;</span>
                <h1 class="text-3xl md:text-4xl font-bold">障害報告書</h1>
            </div>
            <p class="text-lg text-red-100">重複登録問題 - 2026年1月11日〜12日発生</p>
            <div class="mt-4 flex gap-4">
                <a href="index.html" class="text-red-200 hover:text-white text-sm flex items-center gap-1">
                    ← プロジェクト概要に戻る
                </a>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 max-w-4xl">

        <!-- サマリーカード -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4CB;</span> 概要
            </h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-red-50 rounded-lg p-4">
                    <p class="text-sm text-red-600 font-medium">発生日時</p>
                    <p class="text-lg font-bold text-red-800">2026年1月11日〜12日</p>
                </div>
                <div class="bg-orange-50 rounded-lg p-4">
                    <p class="text-sm text-orange-600 font-medium">影響</p>
                    <p class="text-lg font-bold text-orange-800">3件の重複記録が発生</p>
                </div>
                <div class="bg-blue-50 rounded-lg p-4">
                    <p class="text-sm text-blue-600 font-medium">ステータス</p>
                    <p class="text-lg font-bold text-blue-800">&#x2705; 解決済み</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <p class="text-sm text-green-600 font-medium">修正リリース</p>
                    <p class="text-lg font-bold text-green-800">2026年1月12日</p>
                </div>
            </div>
        </div>

        <!-- 何が起きたか -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4A5;</span> 何が起きたか
            </h2>
            <div class="prose max-w-none">
                <p class="text-gray-700 mb-4">
                    スタッフが間食の提供記録を入力する際、<strong class="text-red-600">同じ記録が複数回登録される</strong>問題が発生しました。
                </p>

                <div class="bg-gray-50 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-gray-800 mb-2">影響を受けた記録（3件）</h3>
                    <ul class="space-y-2">
                        <li class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span>1月11日: ヴィさんの記録（2重登録）</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span>1月11日: 興栖さんの記録（2重登録）</span>
                        </li>
                        <li class="flex items-center gap-2">
                            <span class="w-2 h-2 bg-red-500 rounded-full"></span>
                            <span>1月12日: 関久さんの記録（2重登録）</span>
                        </li>
                    </ul>
                </div>

                <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4">
                    <p class="text-yellow-800">
                        <strong>ユーザーの体験:</strong><br>
                        「記録ボタンを押しても反応がなく、もう一度押したら2件登録されていた」
                    </p>
                </div>
            </div>
        </section>

        <!-- なぜ起きたか（図解） -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F50D;</span> なぜ起きたか（原因分析）
            </h2>

            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-3">問題の流れ（改修前）</h3>
                <div class="mermaid">
sequenceDiagram
    participant U as ユーザー
    participant D as ダイアログ
    participant API as サーバー

    U->>D: 記録ボタンをクリック
    Note over D: ボタンが押せる状態のまま
    D->>API: API呼び出し開始（1〜5秒かかる）
    Note over U: 「あれ？反応がない...」
    U->>D: もう一度クリック
    D->>API: API呼び出し（2回目）
    API-->>D: 1回目の結果
    API-->>D: 2回目の結果
    Note over D: 2件とも保存されてしまった！
                </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-6">
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">&#x274C; 問題点1: ダイアログが閉じない</h4>
                    <p class="text-red-700 text-sm">
                        APIの処理完了（1〜5秒）を待ってからダイアログを閉じる設計だったため、
                        その間ユーザーはボタンを何度でも押せる状態でした。
                    </p>
                </div>
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">&#x274C; 問題点2: ボタンが無効化されない</h4>
                    <p class="text-red-700 text-sm">
                        Reactの<code>useState</code>は非同期で更新されるため、
                        1回目のクリック直後に2回目のクリックが来ると、
                        ボタンの無効化が間に合いませんでした。
                    </p>
                </div>
            </div>

            <div class="bg-gray-100 rounded-lg p-4">
                <h4 class="font-bold text-gray-800 mb-2">根本原因（5つのWhy分析）</h4>
                <div class="mermaid">
flowchart TD
    A["なぜ重複が発生した？"] --> B["APIが複数回呼ばれた"]
    B --> C["なぜ複数回呼ばれた？"]
    C --> D["ボタンが連続でクリックされた"]
    D --> E["なぜ連続クリックできた？"]
    E --> F["ダイアログが数秒間開いたままだった"]
    F --> G["なぜ開いたままだった？"]
    G --> H["API完了を待ってから閉じる設計"]

    style H fill:#ff6b6b,stroke:#333,color:#fff
    style F fill:#ffa94d,stroke:#333
                </div>
            </div>
        </section>

        <!-- どう直したか -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F6E0;&#xFE0F;</span> どう直したか（解決策）
            </h2>

            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-3">改善後の流れ</h3>
                <div class="mermaid">
sequenceDiagram
    participant U as ユーザー
    participant D as ダイアログ
    participant T as 通知
    participant API as サーバー

    U->>D: 記録ボタンをクリック
    Note over D: 即座にブロック（useRef）
    D->>D: ダイアログを閉じる
    D->>T: 「記録中...」表示
    Note over U: 操作完了！待つ必要なし
    D->>API: バックグラウンドでAPI呼び出し
    API-->>D: 結果
    D->>T: 「記録しました」表示
                </div>
            </div>

            <div class="overflow-x-auto mb-6">
                <table class="w-full border-collapse">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border p-3 text-left">問題</th>
                            <th class="border p-3 text-left">解決策</th>
                            <th class="border p-3 text-left">効果</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td class="border p-3">ダイアログが開いたまま</td>
                            <td class="border p-3 bg-green-50">即座にダイアログを閉じる</td>
                            <td class="border p-3">&#x2705; ボタンが押せなくなる</td>
                        </tr>
                        <tr>
                            <td class="border p-3">ボタン無効化が遅延</td>
                            <td class="border p-3 bg-green-50"><code>useRef</code>で同期的ブロック</td>
                            <td class="border p-3">&#x2705; 1回目のクリックで即座にブロック</td>
                        </tr>
                        <tr>
                            <td class="border p-3">処理中のフィードバックなし</td>
                            <td class="border p-3 bg-green-50">トースト通知を表示</td>
                            <td class="border p-3">&#x2705; 「記録中...」「完了」が見える</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="grid md:grid-cols-2 gap-4">
                <div class="bg-red-50 rounded-lg p-4">
                    <h4 class="font-bold text-red-800 mb-2">&#x274C; Before</h4>
                    <ol class="text-sm text-red-700 space-y-1 list-decimal list-inside">
                        <li>ボタン押下</li>
                        <li>APIを呼び出し（1〜5秒待機）</li>
                        <li>完了後にダイアログを閉じる</li>
                        <li class="font-bold">→ 待機中に再クリック可能</li>
                    </ol>
                </div>
                <div class="bg-green-50 rounded-lg p-4">
                    <h4 class="font-bold text-green-800 mb-2">&#x2705; After</h4>
                    <ol class="text-sm text-green-700 space-y-1 list-decimal list-inside">
                        <li>ボタン押下</li>
                        <li>即座にダイアログを閉じる</li>
                        <li>「記録中...」通知を表示</li>
                        <li>バックグラウンドでAPI呼び出し</li>
                        <li>完了後に「記録しました」通知</li>
                        <li class="font-bold">→ 再クリック不可能</li>
                    </ol>
                </div>
            </div>
        </section>

        <!-- 技術的な詳細 -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4BB;</span> 技術的な詳細
            </h2>

            <div class="mb-6">
                <h3 class="font-bold text-gray-700 mb-3">なぜ<code>useRef</code>を使うのか？</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div class="bg-red-50 rounded-lg p-4">
                        <h4 class="font-bold text-red-700 mb-2"><code>useState</code>（非同期）</h4>
                        <pre class="text-xs bg-white p-2 rounded overflow-x-auto"><code>const [isSubmitting, setIsSubmitting] = useState(false);

const handleClick = async () => {
  if (isSubmitting) return; // ❌ 間に合わない！
  setIsSubmitting(true);    // 非同期で更新される
  await api.save();
};</code></pre>
                        <p class="text-sm text-red-600 mt-2">
                            状態更新が非同期のため、連続クリックを防げない
                        </p>
                    </div>
                    <div class="bg-green-50 rounded-lg p-4">
                        <h4 class="font-bold text-green-700 mb-2"><code>useRef</code>（同期）</h4>
                        <pre class="text-xs bg-white p-2 rounded overflow-x-auto"><code>const isSubmittingRef = useRef(false);

const handleClick = async () => {
  if (isSubmittingRef.current) return; // ✅ 即座にチェック
  isSubmittingRef.current = true;      // 同期的に更新
  await api.save();
};</code></pre>
                        <p class="text-sm text-green-600 mt-2">
                            値が即座に更新されるため、確実にブロック
                        </p>
                    </div>
                </div>
            </div>

            <div class="bg-blue-50 rounded-lg p-4">
                <h4 class="font-bold text-blue-800 mb-2">実装した共通フック</h4>
                <p class="text-sm text-blue-700 mb-2">
                    <code>useOptimisticSubmit</code>フックを作成し、4つのダイアログコンポーネントに適用しました。
                </p>
                <ul class="text-sm text-blue-700 space-y-1">
                    <li>&#x2022; StaffRecordDialog（間食記録）← 今回の問題箇所</li>
                    <li>&#x2022; ConsumptionRecordModal（消費記録）</li>
                    <li>&#x2022; StaffNoteModal（注意事項）</li>
                    <li>&#x2022; SaveManualPresetDialog（プリセット保存）</li>
                </ul>
            </div>
        </section>

        <!-- 再発防止策 -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F6E1;&#xFE0F;</span> 再発防止策
            </h2>

            <div class="space-y-4">
                <div class="flex items-start gap-3">
                    <span class="text-2xl">&#x2705;</span>
                    <div>
                        <h4 class="font-bold text-gray-800">共通フックの導入</h4>
                        <p class="text-gray-600 text-sm">
                            すべてのフォーム送信で同じパターンを使用し、実装のバラつきを防止
                        </p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-2xl">&#x2705;</span>
                    <div>
                        <h4 class="font-bold text-gray-800">E2Eテストの追加</h4>
                        <p class="text-gray-600 text-sm">
                            送信フローのテストを追加し、回帰を自動検出
                        </p>
                    </div>
                </div>
                <div class="flex items-start gap-3">
                    <span class="text-2xl">&#x2705;</span>
                    <div>
                        <h4 class="font-bold text-gray-800">開発ガイドラインの更新</h4>
                        <p class="text-gray-600 text-sm">
                            新規フォーム作成時は<code>useOptimisticSubmit</code>を使用するルールを策定
                        </p>
                    </div>
                </div>
            </div>
        </section>

        <!-- タイムライン -->
        <section class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F4C5;</span> 対応タイムライン
            </h2>

            <div class="relative border-l-2 border-blue-200 ml-4 pl-6 space-y-6">
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026年1月11日</p>
                    <p class="font-bold text-gray-800">問題発生（2件の重複）</p>
                    <p class="text-gray-600 text-sm">ヴィさん、興栖さんの記録で重複を確認</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026年1月12日 AM</p>
                    <p class="font-bold text-gray-800">追加の重複発生（1件）</p>
                    <p class="text-gray-600 text-sm">関久さんの記録で重複を確認</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026年1月12日</p>
                    <p class="font-bold text-gray-800">原因特定・修正計画策定</p>
                    <p class="text-gray-600 text-sm">5つのWhy分析で根本原因を特定</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026年1月12日</p>
                    <p class="font-bold text-gray-800">修正実装・テスト完了</p>
                    <p class="text-gray-600 text-sm">useOptimisticSubmitフック作成、E2Eテスト308件パス</p>
                </div>
                <div class="relative timeline-item">
                    <p class="text-sm text-gray-500">2026年1月12日</p>
                    <p class="font-bold text-green-600 text-lg">&#x2705; 本番デプロイ完了</p>
                    <p class="text-gray-600 text-sm">PR #198 マージ、自動デプロイ</p>
                </div>
            </div>
        </section>

        <!-- 関連リンク -->
        <section class="bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                <span class="text-2xl">&#x1F517;</span> 関連リンク
            </h2>
            <ul class="space-y-2">
                <li>
                    <a href="https://github.com/yasushihonda-acg/facility-care-input-form/pull/198"
                       target="_blank"
                       class="text-blue-600 hover:underline flex items-center gap-2">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0024 12c0-6.63-5.37-12-12-12z"/></svg>
                        PR #198: feat(ux): 二重送信防止 & 楽観的送信パターンを導入
                    </a>
                </li>
                <li>
                    <a href="index.html" class="text-blue-600 hover:underline flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
                        プロジェクト概要ページ
                    </a>
                </li>
            </ul>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-gray-400 py-6 mt-8">
        <div class="container mx-auto px-4 text-center">
            <p class="text-sm">
                施設ケア入力フォーム - 障害報告書
            </p>
            <p class="text-xs mt-2">
                最終更新: 2026年1月12日
            </p>
        </div>
    </footer>

    <script>
        // Initialize Mermaid
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>
</html>
