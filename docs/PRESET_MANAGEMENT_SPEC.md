# プリセット管理機能 詳細設計書

> **最終更新**: 2025年12月16日
>
> 本ドキュメントは「いつもの指示（プリセット）」の管理機能を定義します。
> 手動CRUD + AI自動ストック化により、家族のケアノウハウをシステムに蓄積します。

---

## 1. 概要

### 1.1 目的

「いつもの指示（プリセット）」は、家族が繰り返し使用するケア指示のテンプレートです。

**解決する課題**:

| 課題 | 現状 | 解決策 |
|------|------|--------|
| 毎回同じ指示を書く手間 | FAXで毎回「キウイは8等分」と記入 | プリセットをワンタップで適用 |
| ノウハウが属人化 | 家族の頭の中にしかない | システムに蓄積・共有 |
| AI提案の使い捨て | 良い提案も1回限り | 気に入った提案を保存可能 |

### 1.2 機能一覧

| 機能 | 説明 |
|------|------|
| **手動CRUD** | プリセットの作成・読取・更新・削除 |
| **AI自動ストック** | AI提案を「いつもの指示」として保存 |
| **出所追跡** | 手動登録 vs AI登録を明示的に区別 |
| **品物登録連携** | ItemFormでプリセット候補を表示・適用 |
| **使用統計** | 使用回数をカウントし、人気順表示 |

### 1.3 関連ドキュメント

| ドキュメント | 関連内容 |
|-------------|---------|
| [FAMILY_UX_DESIGN.md](./FAMILY_UX_DESIGN.md) | View B: ケア仕様ビルダー（プリセット利用） |
| [AI_INTEGRATION_SPEC.md](./AI_INTEGRATION_SPEC.md) | セクション9: プリセット統合、セクション10: AI自動ストック |
| [ITEM_MANAGEMENT_SPEC.md](./ITEM_MANAGEMENT_SPEC.md) | 品物登録フォームとの連携 |

---

## 2. データモデル

### 2.1 CarePreset型定義

```typescript
/**
 * プリセット（いつもの指示）
 * Firestore: care_presets/{presetId}
 */
interface CarePreset {
  // 識別情報
  id: string;
  residentId: string;          // 入居者ID（プリセットは入居者単位）

  // 基本情報
  name: string;                // 表示名（例: "キウイ（8等分・半月切り）"）
  category: PresetCategory;    // カテゴリ
  icon?: string;               // 絵文字アイコン（例: "🥝"）

  // 指示内容
  instruction: {
    content: string;           // 詳細指示テキスト
    servingMethod?: ServingMethod;  // 提供方法
    servingDetail?: string;    // 提供方法の詳細
  };

  // マッチング設定
  matchConfig: {
    keywords: string[];        // マッチングキーワード（例: ["キウイ", "kiwi"]）
    categories?: ItemCategory[];  // マッチするカテゴリ
    exactMatch?: boolean;      // 完全一致のみか（デフォルト: false）
  };

  // 出所追跡（重要）
  source: PresetSource;
  aiSourceInfo?: {
    originalItemName: string;  // AI提案時の元品物名
    originalSuggestion: {      // 元のAI提案内容
      expirationDays: number;
      storageMethod: StorageMethod;
      servingMethods: ServingMethod[];
      notes?: string;
    };
    savedAt: string;           // AI提案保存日時
  };

  // ステータス・統計
  isActive: boolean;           // 有効/無効（論理削除用）
  usageCount: number;          // 使用回数
  lastUsedAt?: string;         // 最終使用日時

  // メタ情報
  createdAt: string;           // ISO8601
  updatedAt: string;           // ISO8601
  createdBy: string;           // 作成者ID
}

/** プリセットカテゴリ */
type PresetCategory =
  | 'cut'        // カット・調理方法
  | 'serve'      // 提供方法
  | 'ban'        // 禁止・制限
  | 'condition'; // 条件付きロジック

/** プリセット出所 */
type PresetSource = 'manual' | 'ai';
```

### 2.2 カテゴリ定義

| カテゴリ | 値 | 説明 | アイコン | 例 |
|---------|-----|------|---------|-----|
| カット・調理 | `cut` | 切り方、調理方法の指示 | ✂️ | キウイ8等分、黒豆煮汁切り |
| 提供方法 | `serve` | 温度、器、タイミングの指示 | 🍽️ | らっきょう冷・小皿 |
| 条件付き | `condition` | If-Thenロジック | 🔀 | みかん残食→おやつ再提供 |

> **重要: プリセットの登録対象**
> - プリセットには**品物（食品）のみ**を登録する
> - 「〇〇は出さない」などの禁止ルールは**プリセットに含めない**（別途「ケア指示」で管理）
> - 各プリセットは**単品ごと**に登録する（例：「黒砂糖・チーズ」は「黒砂糖」「チーズ」に分離）
>
> **禁止ルールの管理方法**:
> 禁止ルールは品物登録時のプリセット選択ではなく、「ケア指示作成」画面で設定する。
> 理由：禁止ルールは品物を送る行為ではなく、既存品物の提供制限であるため。

### 2.3 Firestoreコレクション

```
firestore/
└── care_presets/              # プリセットコレクション
    └── {presetId}
        ├── id: string
        ├── residentId: string
        ├── name: string
        ├── category: string
        ├── icon: string
        ├── instruction: map
        ├── matchConfig: map
        ├── source: string      # 'manual' | 'ai'
        ├── aiSourceInfo: map   # AI登録時のみ
        ├── isActive: boolean
        ├── usageCount: number
        ├── lastUsedAt: timestamp
        ├── createdAt: timestamp
        ├── updatedAt: timestamp
        └── createdBy: string
```

### 2.4 インデックス設計

| コレクション | フィールド | 用途 |
|-------------|-----------|------|
| `care_presets` | `residentId`, `isActive`, `usageCount` | 入居者別・人気順取得 |
| `care_presets` | `residentId`, `category`, `isActive` | カテゴリ別フィルタ |
| `care_presets` | `residentId`, `source`, `createdAt` | 出所別・新着順 |

---

## 3. 初期プリセットデータ（蒲池様FAX準拠）

### 3.1 参考資料からの精査結果

以下は蒲池様のFAX資料に基づく正確なプリセット定義です。

#### 調理・カット系（category: 'cut'）

| ID | 名前 | 詳細指示 | キーワード |
|----|------|---------|-----------|
| `preset-kiwi` | 🥝 キウイ（8等分・半月切り） | 輪切り4等分にしたものを、さらに半分（半月）に切って、8等分にカットしてください。皮は必ず剥いてください。 | キウイ, kiwi |
| `preset-kaki` | 🍑 熟した柿（柔らかい部分も捨てずに） | 熟している柿です。柔らかくなっている部分がとてもおいしいので、傷んでいると判断せず、捨てずにそのままカットして提供してください。 | 柿, かき, 熟した柿 |
| `preset-kuromame` | ⚫ 黒豆（煮汁を切って器へ） | 豆の煮汁を切って、器に移し替えて出してください。 | 黒豆, くろまめ |

#### 提供方法系（category: 'serve'）

| ID | 名前 | 詳細指示 | キーワード |
|----|------|---------|-----------|
| `preset-rakkyo` | 🧅 らっきょう（冷・小皿で提供） | 冷たいほうが美味しいので、小皿に出していただけないでしょうか。常温放置は避けてください。 | らっきょう, ラッキョウ |

#### 条件付きロジック系（category: 'condition'）

| ID | 名前 | 詳細指示 | キーワード |
|----|------|---------|-----------|
| `preset-mikan-retry` | 🍊 みかん（未剥離残食は→おやつへ再提供） | 皮をむかないままの状態で残った際は、おやつ時に再度出してほしいです。 | みかん, ミカン |

#### 単品分離系（category: 'serve'）

> 「黒砂糖・チーズは指定日以外禁止」を単品ごとに分離

| ID | 名前 | 詳細指示 | キーワード |
|----|------|---------|-----------|
| `preset-kurozato` | 🍬 黒砂糖（指定日のみ提供可） | ご家族が指定した日のみ提供してください。指定日以外は提供しないでください。 | 黒砂糖, くろざとう |
| `preset-cheese` | 🧀 チーズ（指定日のみ提供可） | ご家族が指定した日のみ提供してください。指定日以外は提供しないでください。 | チーズ |

### 3.2 プリセット登録対象外（別管理）

以下は品物登録プリセットには含めず、「ケア指示作成」で管理する：

| 元のプリセット | 判定 | 理由 |
|---------------|------|------|
| 🈲 七福のお菓子は出さない | ❌ 対象外 | 禁止ルールであり品物ではない |
| 🍅 トマト月水金禁止 | ❌ 対象外 | 参考資料に記載なし + 禁止ルール |

---

## 4. API設計

### 4.1 プリセットCRUD API

#### 4.1.1 プリセット一覧取得

```
GET /getPresets
```

**リクエストパラメータ**:
| パラメータ | 型 | 必須 | 説明 |
|-----------|-----|------|------|
| residentId | string | ✓ | 入居者ID |
| category | string | | カテゴリフィルタ |
| source | string | | 出所フィルタ（'manual' \| 'ai'） |
| includeInactive | boolean | | 無効も含めるか（デフォルト: false） |

**レスポンス**:
```typescript
interface GetPresetsResponse {
  success: boolean;
  data?: {
    presets: CarePreset[];
    total: number;
  };
  error?: string;
}
```

#### 4.1.2 プリセット作成

```
POST /createPreset
```

**リクエストボディ**:
```typescript
interface CreatePresetRequest {
  residentId: string;
  name: string;
  category: PresetCategory;
  icon?: string;
  instruction: {
    content: string;
    servingMethod?: ServingMethod;
    servingDetail?: string;
  };
  matchConfig: {
    keywords: string[];
    categories?: ItemCategory[];
  };
  source: PresetSource;
  aiSourceInfo?: { /* AI提案保存時 */ };
  createdBy: string;
}
```

**レスポンス**:
```typescript
interface CreatePresetResponse {
  success: boolean;
  data?: {
    presetId: string;
    createdAt: string;
  };
  error?: string;
}
```

#### 4.1.3 プリセット更新

```
PUT /updatePreset
```

**リクエストボディ**:
```typescript
interface UpdatePresetRequest {
  presetId: string;
  updates: Partial<Omit<CarePreset, 'id' | 'createdAt' | 'source' | 'aiSourceInfo'>>;
}
```

#### 4.1.4 プリセット削除（論理削除）

```
DELETE /deletePreset?presetId={presetId}
```

**動作**: `isActive: false` に更新（物理削除ではない）

### 4.2 AI自動ストック API

#### 4.2.1 AI提案をプリセットとして保存

```
POST /saveAISuggestionAsPreset
```

**リクエストボディ**:
```typescript
interface SaveAISuggestionAsPresetRequest {
  residentId: string;
  userId: string;

  // プリセット基本情報
  name: string;                // ユーザーが入力した名前
  category: PresetCategory;
  icon?: string;
  keywords: string[];          // マッチングキーワード

  // 元のAI提案情報
  originalItemName: string;    // 品物名
  originalSuggestion: {
    expirationDays: number;
    storageMethod: StorageMethod;
    servingMethods: ServingMethod[];
    notes?: string;
  };

  // カスタマイズした指示内容（AI提案をベースに編集可能）
  customInstruction?: {
    content: string;
    servingMethod?: ServingMethod;
    servingDetail?: string;
  };
}
```

**レスポンス**:
```typescript
interface SaveAISuggestionAsPresetResponse {
  success: boolean;
  data?: {
    presetId: string;
    createdAt: string;
  };
  error?: string;
}
```

### 4.3 既存APIの拡張

#### getPresetSuggestions（セクション9 拡張）

既存の `getPresetSuggestions` APIは `care_presets` コレクションからマッチするプリセットを検索します。
出所情報（`source`）もレスポンスに含め、UIで手動/AI登録を区別表示できるようにします。

```typescript
// レスポンスのPresetSuggestion型に追加
interface PresetSuggestion {
  // ... 既存フィールド
  source: PresetSource;        // 追加: 出所
  aiSourceInfo?: {             // 追加: AI登録情報
    originalItemName: string;
    savedAt: string;
  };
}
```

---

## 5. UI設計

### 5.1 プリセット管理画面

**パス**: `/family/presets`

```
+----------------------------------------------------------+
|  [←戻る]          いつもの指示                            |
+----------------------------------------------------------+
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 🔍 検索...                                         │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  [全て] [✂️カット] [🍽️提供] [🈲禁止] [🔀条件]            |
|                                                          |
|  ─────────────────────────────────────────────────────── |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 🥝 キウイ（8等分・半月切り）                        │  |
|  │ ───────────────────────────────────────────────── │  |
|  │ 輪切り4等分にしたものを、さらに半分（半月）...      │  |
|  │                                                    │  |
|  │ 📌 手動登録  •  使用回数: 12回                     │  |
|  │                              [編集] [削除]         │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 🍎 りんご（薄切り・皮むき）                        │  |
|  │ ───────────────────────────────────────────────── │  |
|  │ 皮をむいて5mm程度の薄切りにしてください...          │  |
|  │                                                    │  |
|  │ 🤖 AI提案から保存（2025/12/10）  •  使用回数: 3回  │  |
|  │                              [編集] [削除]         │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ─────────────────────────────────────────────────────── |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │           ＋ 新しいプリセットを追加                 │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
+----------------------------------------------------------+
```

### 5.2 プリセット作成/編集モーダル

```
+----------------------------------------------------------+
|                プリセットを追加                            |
|                                              [×]          |
+----------------------------------------------------------+
|                                                          |
|  プリセット名 *                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ キウイ（8等分・半月切り）                          │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  カテゴリ *                                              |
|  [✂️カット▼]                                             |
|                                                          |
|  アイコン                                                |
|  [🥝] [🍎] [🍊] [🍑] [🧅] [⚫] [🈲] [⚠️] [🔀]            |
|                                                          |
|  詳細指示 *                                              |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 輪切り4等分にしたものを、さらに半分（半月）に      │  |
|  │ 切って、8等分にカットしてください。                │  |
|  │ 皮は必ず剥いてください。                          │  |
|  │                                                    │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  キーワード（カンマ区切り）                              |
|  ┌────────────────────────────────────────────────────┐  |
|  │ キウイ, kiwi, 果物                                 │  |
|  └────────────────────────────────────────────────────┘  |
|  ※ 品物登録時にこれらのキーワードでマッチします         |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │                   保存する                         │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
+----------------------------------------------------------+
```

### 5.3 AI提案保存ダイアログ

品物登録フォームでAI提案を適用した際に表示：

```
+----------------------------------------------------------+
|        この設定を「いつもの指示」として保存しますか？      |
+----------------------------------------------------------+
|                                                          |
|  保存すると、次回から同じ品物を登録する際に              |
|  自動的に候補として表示されます。                        |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 🍎 りんご                                          │  |
|  │ ─────────────────────────────────────────────────  │  |
|  │ 賞味期限: 7日                                      │  |
|  │ 保存方法: 冷蔵                                     │  |
|  │ 提供方法: カット、皮むき                           │  |
|  │ 注意: 皮をむいて食べやすい大きさにカット...        │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  プリセット名                                            |
|  ┌────────────────────────────────────────────────────┐  |
|  │ りんご（カット・皮むき）                           │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ┌──────────────────┐  ┌──────────────────┐             |
|  │    今回だけ      │  │  保存して適用    │             |
|  └──────────────────┘  └──────────────────┘             |
|                                                          |
+----------------------------------------------------------+
```

### 5.4 出所バッジ表示

| 出所 | バッジ | 背景色 |
|------|--------|--------|
| 手動登録 | 📌 手動登録 | `bg-gray-100` |
| AI提案から | 🤖 AI提案から保存（日付） | `bg-purple-100` |

---

## 6. 画面フロー

### 6.1 全体フロー

> **重要な設計原則**:
> - プリセットの**主な利用場所は「品物登録」**（恒久的な指示を設定）
> - 「ケア指示作成」では参考表示のみ（一時的な変更・追記用）

```
┌─────────────────────────────────────────────────────────────┐
│                     家族ホーム                              │
│                    /family                                  │
└─────────────────────────────────────────────────────────────┘
         │                    │                    │
         ↓                    ↓                    ↓
┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
│ 品物登録        │ │ ケア指示作成    │ │ プリセット管理  │
│ /family/items/new│ │ /family/request │ │ /family/presets │
│                 │ │                 │ │                 │
│ ★主な利用場所   │ │ 参考表示のみ    │ │ CRUD管理        │
└─────────────────┘ └─────────────────┘ └─────────────────┘
         │                    │                    │
         │ プリセット適用     │ 参照（変更時）     │
         │ + AI提案適用       │                    │
         ↓                    ↓                    ↓
┌─────────────────────────────────────────────────────────────┐
│                  care_presets コレクション                  │
│                    （Firestore）                            │
└─────────────────────────────────────────────────────────────┘
```

### 6.2 機能の使い分け

| 用途 | 画面 | プリセットの役割 |
|------|------|-----------------|
| 品物送付時の指示設定 | **品物登録** | プリセット適用で提供方法詳細を自動入力（主要） |
| 登録済み指示の変更・追記 | **ケア指示作成** | 登録済み内容を参考表示（補助的） |
| プリセット自体の管理 | **プリセット管理** | CRUD操作（作成・編集・削除） |

### 6.3 AI提案→プリセット保存フロー

```
1. 品物登録フォームで品物名入力
        │
        ↓
2. AI提案カードが表示される
        │
        ↓
3. 「この提案を適用」をタップ
        │
        ↓
4. 保存ダイアログ表示
   「この設定を『いつもの指示』として保存しますか？」
        │
        ├─→ 「今回だけ」 → フォームに適用のみ
        │
        └─→ 「保存して適用」
                │
                ↓
        5. プリセット名を入力
                │
                ↓
        6. Firestore care_presets に保存
           （source: 'ai', aiSourceInfo付き）
                │
                ↓
        7. フォームに適用 + 完了トースト
```

---

## 7. 実装ファイル構成

```
frontend/src/
├── pages/
│   └── family/
│       ├── PresetManagement.tsx     # プリセット管理画面（新規）
│       ├── ItemForm.tsx             # プリセット適用（主要）+ AI提案保存
│       └── RequestBuilder.tsx       # プリセット参考表示（補助的）
├── components/
│   └── family/
│       ├── PresetCard.tsx           # プリセットカード（新規）
│       ├── PresetFormModal.tsx      # 作成/編集モーダル（新規）
│       ├── SaveAISuggestionDialog.tsx # AI提案保存ダイアログ（新規）
│       └── PresetSuggestion.tsx     # 既存: 出所バッジ追加
├── hooks/
│   └── usePresets.ts                # プリセットCRUDフック（新規）
├── types/
│   └── preset.ts                    # プリセット型定義（新規）
└── data/
    └── initialPresets.ts            # 初期プリセットデータ（新規）

functions/src/
├── functions/
│   ├── presets.ts                   # プリセットCRUD API（新規）
│   ├── saveAISuggestionAsPreset.ts  # AI提案保存API（新規）
│   └── getPresetSuggestions.ts      # 既存: 出所情報追加
└── types/
    └── index.ts                     # CarePreset型追加
```

---

## 8. 実装優先度

| 優先度 | タスク | 理由 |
|--------|--------|------|
| **高** | 初期プリセットデータ修正 | 参考資料に基づく正確なデータが必要 |
| **高** | プリセット管理画面（CRUD） | 基本機能 |
| **高** | getPresetSuggestions 出所情報追加 | 既存APIの拡張 |
| **中** | AI提案保存ダイアログ | UX向上 |
| **中** | saveAISuggestionAsPreset API | AI連携 |
| **低** | 使用統計・人気順ソート | 運用後の改善 |

---

## 9. 実装計画

### Phase 8.6: プリセット管理基盤

| ステップ | 内容 | 状態 |
|----------|------|------|
| 1 | 設計書作成（本ドキュメント） | ✅ 完了 |
| 2 | 初期プリセットデータ修正（demoFamilyData.ts） | ✅ 完了 |
| 3 | プリセット型定義（frontend/backend） | ✅ 完了 |
| 4 | プリセットCRUD API（backend） | ✅ 完了 |
| 5 | プリセット管理画面（frontend） | ✅ 完了 |
| 6 | ルーティング追加（/family/presets） | ✅ 完了 |

### Phase 8.7: AI自動ストック連携

| ステップ | 内容 | 状態 |
|----------|------|------|
| 1 | saveAISuggestionAsPreset API | ✅ 完了 |
| 2 | SaveAISuggestionDialog コンポーネント | ✅ 完了 |
| 3 | ItemForm.tsx 統合 | ✅ 完了 |
| 4 | getPresetSuggestions 出所情報追加 | ✅ 完了 |
| 5 | PresetSuggestion.tsx 出所バッジ表示 | ✅ 完了 |

---

## 10. 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-16 | Phase 8.6/8.7 実装完了を反映 |
| 2025-12-16 | 初版作成（プリセット管理機能詳細設計） |
