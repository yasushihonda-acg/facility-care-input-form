# デモ版PWA仕様書

## 1. 概要

**目的**: 介護施設スタッフ向けに、Sheet A（記録の結果）の全シートデータをモバイルで閲覧可能にする

**種別**: Progressive Web App (PWA)

**フェーズ**: デモ版（読み取り専用）

---

## 2. 機能一覧

### 2.1 コア機能

| 機能 | 説明 | 優先度 |
|------|------|--------|
| シート一覧表示 | 全11シートをリスト表示 | 必須 |
| シートデータ閲覧 | 選択したシートのデータをテーブル表示 | 必須 |
| 自動同期 | 15分ごとにバックグラウンドでデータ更新 | 必須 |
| 手動同期 | ユーザー操作でデータを即座に更新 | 必須 |
| 同期状態表示 | 最終同期日時・同期中インジケータ | 必須 |

### 2.2 将来拡張（デモ版対象外）

| 機能 | 説明 | 備考 |
|------|------|------|
| 実績入力 | Sheet Bへの書き込み | Sheet B共有後に対応 |
| 画像アップロード | ケア記録への画像添付 | Phase 2 |
| 家族要望送信 | Firestoreへの要望登録 | Phase 2 |
| プッシュ通知 | 更新通知 | Phase 3 |

---

## 3. データ同期仕様

### 3.1 同期タイミング

| トリガー | 間隔 | 処理 |
|----------|------|------|
| 自動同期 | 15分ごと | バックグラウンドで`syncPlanData` API呼び出し |
| 手動同期 | ユーザー操作時 | 画面上のボタンタップで即座に同期実行 |
| アプリ起動時 | 初回起動 | 前回同期から5分以上経過していれば自動同期 |

### 3.2 同期フロー

```mermaid
sequenceDiagram
    participant PWA as PWA (Frontend)
    participant CF as Cloud Functions
    participant SA as Sheet A
    participant FS as Firestore

    alt 自動同期（15分ごと）
        PWA->>CF: POST /syncPlanData
        CF->>SA: 全シート読み取り
        SA-->>CF: データ返却
        CF->>FS: 洗い替え同期
        CF-->>PWA: 同期結果（件数・シート名）
    end

    alt 手動同期
        Note over PWA: ユーザーが同期ボタンをタップ
        PWA->>CF: POST /syncPlanData
        CF->>SA: 全シート読み取り
        SA-->>CF: データ返却
        CF->>FS: 洗い替え同期
        CF-->>PWA: 同期結果
        PWA->>CF: GET /getPlanData
        CF->>FS: データ取得
        FS-->>CF: plan_dataコレクション
        CF-->>PWA: データ表示用JSON
    end
```

### 3.3 同期対象シート

Sheet A（記録の結果）の全11シート：

| シート名 | 概要 |
|----------|------|
| 食事 | 食事に関する指示・制限 |
| 水分摂取量 | 水分摂取の記録 |
| 排便・排尿 | 排泄に関する記録 |
| バイタル | バイタルサイン記録 |
| 口腔ケア | 口腔ケアに関する記録 |
| 内服 | 服薬に関する記録 |
| 特記事項 | 特記すべき事項 |
| 血糖値インスリン投与 | 血糖値・インスリン記録 |
| 往診録 | 往診に関する記録 |
| 体重 | 体重測定記録 |
| カンファレンス録 | カンファレンス記録 |

---

## 4. 画面設計

### 4.1 画面構成（Phase 4.2: テーブルビュー）

| 画面ID | 画面名 | 概要 |
|--------|--------|------|
| HOME | ホーム | タブ形式シート切り替え + テーブルビュー |

> **変更履歴**: Phase 4.1 のカードビューから Phase 4.2 でテーブルビューに変更

### 4.2 HOME画面（タブUI + テーブルビュー）

```
+--------------------------------------------------+
|  介護記録ビューア                   [🔄 同期]    |
|  最終同期: 16:45  [同期中...]                    |
+--------------------------------------------------+
|  [バイタル 523] [体重 145] [往診録 89] [...]  →   |
|  (横スクロール可能なタブバー)                     |
+--------------------------------------------------+
| [🔍 検索...]                    [↕️ ソート ▼]    |
+--------------------------------------------------+
|                                                  |
| +----------------------------------------------+ |
| | 日時         | スタッフ | 入居者   | 体温   | → |
| +----------------------------------------------+ |
| | 2025/01/15   | 田中花子 | 山田太郎 | 36.5  | → |
| |   09:00      |          |          |        | |
| +----------------------------------------------+ |
| | 2025/01/15   | 佐藤一郎 | 鈴木花子 | 36.8  | → |
| |   09:15      |          |          |        | |
| +----------------------------------------------+ |
| | ...          | ...      | ...      | ...   | |
| +----------------------------------------------+ |
|                                                  |
| [← 前へ] 1 / 11 ページ [次へ →]                  |
+--------------------------------------------------+
```

### 4.3 UI コンポーネント詳細

#### タブバー
| 項目 | 仕様 |
|------|------|
| レイアウト | 横スクロール可能なタブ |
| 表示内容 | シート名 + レコード数バッジ |
| 選択状態 | アクティブタブをハイライト |
| 動作 | タップでシート切り替え |

#### テーブルビュー
| 項目 | 仕様 |
|------|------|
| ヘッダー | シートのカラム名を動的に表示 |
| セル | 各レコードのデータを表示 |
| 横スクロール | カラム数が多い場合は横スクロール対応 |
| 行タップ | 詳細モーダル表示 |

#### 詳細モーダル（中央配置）
| 項目 | 仕様 |
|------|------|
| トリガー | テーブル行をタップ |
| 表示形式 | **画面中央**に表示（フェードイン） |
| サイズ | 幅: 90%（max 600px）、高さ: 最大80vh |
| コンテンツ | 全カラムを2カラムグリッド（ラベル: 値）で表示 |
| 閉じる操作 | 背景タップ、×ボタン、ESCキー |
| アニメーション | フェードイン/アウト + スケール（200ms） |

**設計の理由**:
- カラム数が多いデータは中央配置の方が視認性が高い
- 2カラムグリッドで情報を効率的に表示
- モバイル・デスクトップ両方で適切なサイズに対応

```
+----------------------------------------------------------+
|                                                          |
|    +------------------------------------------------+    |
|    |  [×]                                           |    |
|    |  血糖値インスリン投与 詳細                       |    |
|    |  2025/12/12 19:34:17                           |    |
|    +------------------------------------------------+    |
|    |                                                |    |
|    |  日時              2025/12/12 19:34:17         |    |
|    |  スタッフ名        リー                         |    |
|    |  入居者名          215_蒲地 キヌヱ様(ID7282)   |    |
|    |  タイムスタンプ     -                          |    |
|    |  特記事項          【ケアに関すること】【ACPiece】|    |
|    |  重要特記事項...    重要ではない/キーワードなし  |    |
|    |                                                |    |
|    |  ─────────────────────────────────────────    |    |
|    |  同期日時: 2025/12/13 17:57:08                 |    |
|    +------------------------------------------------+    |
|                                                          |
+----------------------------------------------------------+
```

#### 検索・フィルタ
| 項目 | 仕様 |
|------|------|
| 検索対象 | 入居者名、スタッフ名 |
| 検索方式 | 部分一致（前方・後方） |
| リアルタイム | 入力ごとにフィルタ適用 |

#### ソート機能
| 項目 | 仕様 |
|------|------|
| デフォルト | 日時降順（新しい順） |
| ソート対象 | 日時、入居者名、スタッフ名 |
| 方向切替 | 昇順/降順トグル |

### 4.4 レスポンシブ対応

| 画面幅 | レイアウト |
|--------|-----------|
| < 640px (モバイル) | カラム数制限（4列）、横スクロール |
| 640px〜1024px (タブレット) | カラム数制限（6列）、横スクロール |
| > 1024px (デスクトップ) | 全カラム表示 |

---

## 5. 使用API

### 5.1 バックエンドAPI

| メソッド | エンドポイント | 用途 | 備考 |
|----------|---------------|------|------|
| POST | `/syncPlanData` | Sheet A → Firestore同期 | 自動・手動同期で使用 |
| GET | `/getPlanData` | Firestore → PWA取得 | 画面表示用 |
| GET | `/healthCheck` | ヘルスチェック | 接続確認用 |

### 5.2 API呼び出し例

```javascript
// 手動同期
async function syncData() {
  // Step 1: Sheet A → Firestore 同期
  const syncRes = await fetch(
    'https://asia-northeast1-facility-care-input-form.cloudfunctions.net/syncPlanData',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ triggeredBy: 'manual' })
    }
  );

  // Step 2: Firestore → PWA データ取得
  const dataRes = await fetch(
    'https://asia-northeast1-facility-care-input-form.cloudfunctions.net/getPlanData'
  );
  return dataRes.json();
}
```

---

## 6. 技術スタック

### 6.1 フロントエンド

| 項目 | 技術 | 理由 |
|------|------|------|
| フレームワーク | React + Vite | 高速ビルド、PWA対応容易 |
| UI | Tailwind CSS または MUI | モバイルファースト |
| 状態管理 | React Query (TanStack Query) | キャッシュ・自動再取得 |
| PWA | Vite PWA Plugin | Service Worker自動生成 |

### 6.2 PWA要件

| 項目 | 対応 |
|------|------|
| HTTPS | Firebase Hosting で自動対応 |
| Service Worker | オフラインキャッシュ（読み取りデータ） |
| Web App Manifest | ホーム画面追加対応 |
| レスポンシブ | モバイルファースト設計 |

---

## 7. デプロイ

### 7.1 ホスティング

| 項目 | 値 |
|------|-----|
| サービス | Firebase Hosting |
| ドメイン | `facility-care-input-form.web.app` |
| リージョン | 自動（CDN） |

### 7.2 デプロイコマンド

```bash
# フロントエンドビルド
cd frontend
npm run build

# Firebase Hosting へデプロイ
firebase deploy --only hosting
```

---

## 8. 開発フェーズ

### Phase 4-1: PWA基盤構築 ✅ 完了

- [x] Vite + React プロジェクト作成
- [x] PWA設定（manifest.json, Service Worker）
- [x] Firebase Hosting 初期設定
- [x] TailwindCSS v4 + TanStack Query 導入

### Phase 4.1: タブUI・汎用データモデル ✅ 完了

- [x] 汎用データモデル対応（列名→値マップ）
- [x] タブ形式シート切り替えUI
- [x] カードビューでのレコード表示
- [x] 同期トースト通知
- [x] Firestoreインデックス作成

### Phase 4.2: テーブルビュー・検索・ソート・詳細モーダル ✅ 完了

- [x] カードビュー → テーブルビューへ変更
- [x] 動的カラムヘッダー表示
- [x] 検索フィルタ機能
- [x] ソート機能（日時、入居者名、スタッフ名）
- [x] ページネーション
- [x] 詳細モーダル（行タップでボトムシート表示）

### Phase 4-3: 追加機能（将来）

- [ ] エクスポート機能（CSV）
- [ ] 高度なフィルタ（日付範囲）

---

## 9. 制約事項

### デモ版の制約

| 項目 | 制約 | 理由 |
|------|------|------|
| 認証 | なし | Dev Mode |
| 書き込み | 不可 | 読み取り専用デモ |
| オフライン | 限定的 | 最後の同期データのみ |
| 通知 | なし | Phase 2以降 |

### パフォーマンス考慮

| 項目 | 対策 |
|------|------|
| 大量データ | ページネーション（1シート100件ずつ） |
| 同期時間 | ローディングインジケータ表示 |
| バッテリー | 15分間隔で負荷軽減 |

---

## 10. 関連ドキュメント

| ドキュメント | 内容 |
|--------------|------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | システム全体設計 |
| [API_SPEC.md](./API_SPEC.md) | API仕様詳細 |
| [ROADMAP.md](./ROADMAP.md) | 開発ロードマップ |
| [CURRENT_STATUS.md](./CURRENT_STATUS.md) | 現在の進捗 |
