# 技術的負債レビュー（2025年1月）

## Status

Accepted

## Context

AI駆動開発を継続する上で、コードベースの品質・セキュリティ上の問題を特定し、優先度を付けて対処計画を立てる必要がある。Codex（GPT）によるコードレビューで以下の問題が指摘された。

## 指摘事項と対応方針

### High（重大）- 早期対応必須

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| H1 | `admin=true`クエリで認証なしで設定変更可能 | `mealFormSettings.ts:101-140` | ✅ Firebase Auth認証を追加 | Phase 69（完了） |
| H2 | timestamp形式の不整合（YYYY-MM-DD vs YYYY/MM/DD HH:mm:ss） | `summaryService.ts:101-112` | ⏸️ 延期（下記参照） | - |
| H3 | `keys/sa-key.json`の存在 | `keys/` | ✅ .gitignoreで管理済み | 対応不要 |

### Medium（中程度）- 計画的に対応

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| M1 | 同期の読み取り範囲が`A1:Z`固定 | `syncPlanData.ts:136-140` | 動的範囲取得に変更 | 将来 |
| M2 | timestamp文字列でのソート/フィルタ | `firestoreService.ts:52-58` | ⏸️ 延期（下記参照） | - |
| M3 | 水分記録更新のタイムスタンプ完全一致検索 | `sheetsService.ts:351-375` | 行番号ベースの更新に変更 | 将来 |
| M4 | 決定論的IDがstaffName等に依存 | `firestoreService.ts:72-83` | UUID生成に移行を検討 | 将来 |

### Low（軽微）- 余裕があれば対応

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| L1 | フロント/サーバで同一ロジックの二重実装 | `utils/*.ts` | 共通パッケージ化を検討 | 将来 |
| L2 | Chat APIログにPII出力の可能性 | `chatApiService.ts:46-88` | ログレベル/マスキング調整 | 将来 |

## Decision

1. **H1（認証問題）を最優先で対応** - セキュリティリスクが高いため ✅完了
2. **H2/M2（timestamp問題）は延期** - 下記理由により対応不要と判断
3. **M1/M3/M4/L1/L2は将来のリファクタリングPhaseで対応**

### H2/M2 延期の理由（2025-01-27 再評価）

Phase 70として実装を試みたが、以下の理由で延期を決定：

#### 影響範囲の再調査結果

| 機能 | 影響 | 理由 |
|------|------|------|
| ViewPage（記録閲覧） | ✅ 問題なし | `orderBy`のみ。文字列ソートでも正しく動作 |
| getPlanData API | ✅ 問題なし | year/monthフィールドで絞り込み |
| summaryService | ❌ 壊れている | timestamp形式不一致でクエリが0件を返す |

#### summaryServiceの状況

- **フロントエンドで未使用**: `getSummaries` APIを呼び出すコードが存在しない
- **Phase 46で実装されたが統合されていない**: バックエンドのみ実装
- **壊れていても誰も困らない**: 報告なし、使用実績なし
- **修正するとGemini API課金が発生**: 現状は呼び出しが失敗しているため課金なし

#### リスク vs メリット

| 選択肢 | リスク | メリット |
|--------|--------|----------|
| 修正する | 予期せぬ問題、API課金増、未テストの機能が有効化 | 使われていない機能が動く |
| 延期する | なし | 安全、現状維持 |

**結論**: ユーザーに影響がなく、修正のリスクがメリットを上回るため延期。
将来summaryServiceを使用する際に、適切にテストして対応する。

## Consequences

### メリット
- セキュリティリスクの軽減（H1完了）
- 不要な修正によるリスクを回避（H2/M2延期）

### デメリット
- summaryServiceは壊れたまま（ただし使用されていないため影響なし）

## Alternatives

1. **全て一度に対応する** - 工数が大きすぎるため却下
2. **対応しない** - H1はセキュリティリスクがあるため却下、H2/M2は採用（影響なし）
3. **優先度順に段階的に対応する** - H1のみ採用

## 関連Issue

- [x] #271: H1 - mealFormSettings認証追加（Phase 69で完了）
- [x] #272: H2/M2 - 延期決定（影響なし、修正リスクが高い）
- [x] #280: Phase 70実装 → #281でロールバック（教訓として記録）

## 教訓（Phase 70の失敗から）

1. **使われていない機能を「直す」のはリスク** - 動作確認されていないコードパスが有効化される
2. **理論的な問題 ≠ 実際の問題** - 影響範囲を実データで検証すべき
3. **Firestoreの`orderBy`は存在しないフィールドを除外する** - マイグレーション中は特に注意

## 更新履歴

- 2025-01-27: H2/M2延期決定（影響調査の結果、対応不要と判断）
- 2025-01-27: Phase 70実装→ロールバック（#280→#281）
- 2025-01-27: H1完了（Phase 69 - Firebase Auth認証追加）
- 2025-01-27: 初版作成（Codexレビュー結果に基づく）
