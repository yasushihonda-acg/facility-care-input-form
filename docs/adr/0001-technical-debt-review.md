# 技術的負債レビュー（2025年1月）

## Status

Accepted

## Context

AI駆動開発を継続する上で、コードベースの品質・セキュリティ上の問題を特定し、優先度を付けて対処計画を立てる必要がある。Codex（GPT）によるコードレビューで以下の問題が指摘された。

## 指摘事項と対応方針

### High（重大）- 早期対応必須

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| H1 | `admin=true`クエリで認証なしで設定変更可能 | `mealFormSettings.ts:101-140` | Firebase Auth認証を追加 | Phase 69 |
| H2 | timestamp形式の不整合（YYYY-MM-DD vs YYYY/MM/DD HH:mm:ss） | `summaryService.ts:101-112` | 保存時にISO形式に統一 | Phase 70 |
| H3 | `keys/sa-key.json`の存在 | `keys/` | ✅ .gitignoreで管理済み | 対応不要 |

### Medium（中程度）- 計画的に対応

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| M1 | 同期の読み取り範囲が`A1:Z`固定 | `syncPlanData.ts:136-140` | 動的範囲取得に変更 | 将来 |
| M2 | timestamp文字列でのソート/フィルタ | `firestoreService.ts:52-58` | Firestore Timestamp型に移行 | Phase 70 |
| M3 | 水分記録更新のタイムスタンプ完全一致検索 | `sheetsService.ts:351-375` | 行番号ベースの更新に変更 | 将来 |
| M4 | 決定論的IDがstaffName等に依存 | `firestoreService.ts:72-83` | UUID生成に移行を検討 | 将来 |

### Low（軽微）- 余裕があれば対応

| ID | 問題 | 対象ファイル | 対応方針 | 対応Phase |
|----|------|-------------|----------|-----------|
| L1 | フロント/サーバで同一ロジックの二重実装 | `utils/*.ts` | 共通パッケージ化を検討 | 将来 |
| L2 | Chat APIログにPII出力の可能性 | `chatApiService.ts:46-88` | ログレベル/マスキング調整 | 将来 |

## Decision

1. **H1（認証問題）を最優先で対応** - セキュリティリスクが高いため
2. **H2/M2（timestamp問題）をセットで対応** - データ整合性に影響
3. **M1/M3/M4/L1/L2は将来のリファクタリングPhaseで対応**

## Consequences

### メリット
- セキュリティリスクの軽減
- データ整合性の向上
- 将来の機能追加時の問題発生リスク低減

### デメリット
- 対応工数が必要
- timestamp移行時に既存データのマイグレーションが必要

## Alternatives

1. **全て一度に対応する** - 工数が大きすぎるため却下
2. **対応しない** - リスクが残るため却下
3. **優先度順に段階的に対応する** - 採用

## 関連Issue

- [ ] #271: H1 - mealFormSettings認証追加
- [ ] #272: H2/M2 - timestamp形式統一

## 更新履歴

- 2025-01-27: 初版作成（Codexレビュー結果に基づく）
