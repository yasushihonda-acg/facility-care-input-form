# 家族向けUX設計書 (Family Side UX Design)

> **最終更新**: 2025年12月15日
>
> このドキュメントは「ご家族向け機能」のUX設計を定義します。
> FAXの代替となる入力機能と、安心を提供する確認画面を実装します。

---

## 1. コンセプト：『遠隔ケア・コックピット』

### 1.1 解決する課題

| 課題 | 現状（FAX） | 解決策（アプリ） |
|------|------------|------------------|
| **指示の不透明さ** | FAXを送っても、実際に実施されたか確認できない | 写真付きエビデンスで「実施確認」を可能に |
| **手書きの手間** | 詳細な指示を毎回手書きするのは大変 | プリセット＋構造化入力で効率化 |
| **条件付き指示の複雑さ** | 「もし残食があれば...」という条件付き指示が伝わりにくい | If-Then形式のUI |
| **リアルタイム性の欠如** | FAX送信後の状況がわからない | タイムラインで食事提供状況をリアルタイム確認 |

### 1.2 ターゲットユーザー

- **蒲池様ご家族**: 入居者様の食事ケアに強いこだわりを持ち、詳細な指示を出したい方
- **特徴**: FAXで「キウイの切り方」「らっきょうの温度」など細かい指示を送っている

---

## 2. 画面構成（3つのビュー）

```
/family                    → FamilyDashboard (View C: 家族ホーム)
/family/evidence/:date     → EvidenceMonitor (View A: エビデンス・モニター)
/family/request            → RequestBuilder (View B: ケア仕様ビルダー)
```

---

## 3. View A: エビデンス・モニター（安心確認）

### 3.1 目的

**「指示通りに行われたか？」を写真で証明する画面**

ご家族が送った「ケア指示（Plan）」と、スタッフが実施した「ケア結果（Result）」を**対比表示**し、写真エビデンスで安心感を提供します。

### 3.2 画面構成

```
+----------------------------------------------------------+
|  [←戻る]  エビデンス・モニター         2025/12/14 昼食    |
+----------------------------------------------------------+
|                                                          |
|  ┌─────────────────────────────────────────────────────┐ |
|  │ 📋 PLAN（指示内容）                                   │ |
|  │ ─────────────────────────────────────────────────── │ |
|  │ キウイ 1/2玉                                         │ |
|  │                                                     │ |
|  │ 【詳細指示】                                         │ |
|  │ 輪切り4等分をさらに半分に切ってください。              │ |
|  │ 皮は必ず剥いてください。                              │ |
|  │ 種が多い部分は避けてください。                        │ |
|  │                                                     │ |
|  │ ⚠️ 絶対厳守                                         │ |
|  └─────────────────────────────────────────────────────┘ |
|                                                          |
|                    ↓ 対比 ↓                              |
|                                                          |
|  ┌─────────────────────────────────────────────────────┐ |
|  │ ✅ RESULT（実施結果）                                │ |
|  │ ─────────────────────────────────────────────────── │ |
|  │ +------------------------------------------+        │ |
|  │ |                                          |        │ |
|  │ |         📷 提供直前の写真                 |        │ |
|  │ |                                          |        │ |
|  │ |    [キウイが8等分にカットされた写真]       |        │ |
|  │ |                                          |        │ |
|  │ +------------------------------------------+        │ |
|  │                                                     │ |
|  │ 記録者: 田中花子                                     │ |
|  │ 記録日時: 2025/12/14 12:15                          │ |
|  │ 摂取量: 主食8割 / 副食7割                            │ |
|  │ 備考: 美味しそうに召し上がりました                    │ |
|  └─────────────────────────────────────────────────────┘ |
|                                                          |
+----------------------------------------------------------+
```

### 3.3 データ結合ロジック

Plan（Flow A/C）とResult（Flow B）を以下の条件でJOINします：

```typescript
// 結合キー
type JoinKey = {
  targetDate: string;    // "2025-12-14"
  mealTime: 'breakfast' | 'lunch' | 'dinner' | 'snack';
  menuName?: string;     // "キウイ" (オプション)
};
```

### 3.4 重要設計原則

> **FAXの再現性**: `processingDetail`（詳細指示）フィールドは**絶対に省略しない**。
> UIは長文テキストを折り返して全文表示する設計とし、「もっと見る」で隠すことは禁止。

---

## 4. View B: ケア仕様ビルダー（構造化入力）

### 4.1 目的

**FAXの手書き指示をアプリ入力に置き換える画面**

自由記述ではなく、選択式フォームで構造化された指示を作成します。

### 4.2 画面構成

```
+----------------------------------------------------------+
|  [←戻る]          ケア指示の作成                          |
+----------------------------------------------------------+
|                                                          |
|  📅 対象日                                               |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 2025年12月15日                            [📅]    │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  🍽️ 食事タイミング                                       |
|  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐                    |
|  │  朝  │ │ 昼 ✓ │ │  夜  │ │ 間食 │                    |
|  └──────┘ └──────┘ └──────┘ └──────┘                    |
|                                                          |
|  🥝 メニュー名                                           |
|  ┌────────────────────────────────────────────────────┐  |
|  │ キウイ                                              │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ⚡ いつもの指示（プリセット）                            |
|  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐      |
|  │ キウイ8等分  │ │ らっきょう冷 │ │ 柿は皮むき  │      |
|  └──────────────┘ └──────────────┘ └──────────────┘      |
|  ┌──────────────┐                                        |
|  │ + カスタム   │                                        |
|  └──────────────┘                                        |
|                                                          |
|  📝 詳細指示（※必須）                                    |
|  ┌────────────────────────────────────────────────────┐  |
|  │ 輪切り4等分をさらに半分に切ってください。            │  |
|  │ 皮は必ず剥いてください。                            │  |
|  │ 種が多い部分は避けてください。                      │  |
|  │                                                    │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  🔀 条件付きロジック                                     |
|  ┌────────────────────────────────────────────────────┐  |
|  │ もし [ 残食あり ▼ ] なら                           │  |
|  │      → [ おやつに回す ▼ ]                          │  |
|  │                                        [+ 条件追加] │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ⚠️ 優先度                                               |
|  ┌────────────────────────────────────────────────────┐  |
|  │ [○ 通常]  [● 絶対厳守]                              │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │               📤 指示を送信する                     │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
+----------------------------------------------------------+
```

### 4.3 プリセット設定

デモ用に以下のプリセットをハードコードします（蒲池様FAX内容に基づく）：

| プリセット名 | 詳細内容 |
|-------------|----------|
| キウイ8等分 | 輪切り4等分をさらに半分に切る。皮は必ず剥く。種が多い部分は避ける。 |
| らっきょう冷 | らっきょうは冷たいまま提供。常温放置しない。 |
| 柿は皮むき | 柿は必ず皮をむいてから提供。薄切りにする。 |
| トマト月水金禁止 | 月・水・金のみ禁止（リハビリ後は消化に負担）。他の曜日は少量可。 |

### 4.4 条件ロジック選択肢

**トリガー（もし〜なら）**:
- 残食あり
- 体調不良
- 食欲なし
- リハビリ後

**アクション（→ 〜する）**:
- おやつに回す
- 量を減らす
- 提供を中止
- 代替メニューに変更

---

## 5. View C: 家族ホーム（タイムライン）

### 5.1 目的

**時系列で1日の食事提供状況を一覧表示**

朝・昼・間食・夕のタイムラインで、指示と実績のステータスを確認できます。

### 5.2 画面構成

```
+----------------------------------------------------------+
|  家族ホーム                              🔔 [⚙️設定]      |
|  蒲池 キヌヱ様                                           |
+----------------------------------------------------------+
|                                                          |
|  📅 2025年12月14日（土）                                 |
|  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐            |
|  │ ◀   │ │ 12  │ │ 13  │ │ 14 ● │ │  ▶  │            |
|  └──────┘ └──────┘ └──────┘ └──────┘ └──────┘            |
|                                                          |
|  ─────────────────────────────────────────────────────── |
|                                                          |
|  🌅 朝食 (7:30)                                          |
|  ┌────────────────────────────────────────────────────┐  |
|  │ ✅ 完了                                             │  |
|  │ 主食: 8割 / 副食: 7割                               │  |
|  │ [📷 写真を見る]                                     │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  ☀️ 昼食 (12:00)                                         |
|  ┌────────────────────────────────────────────────────┐  |
|  │ ✅ 完了                                             │  |
|  │ キウイ（8等分カット）✓ 指示通り                      │  |
|  │ 主食: 全量 / 副食: 8割                              │  |
|  │ [📷 写真を見る] [📋 詳細を確認]                      │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  🍪 間食 (15:00)                           ⚠️ 重要       |
|  ┌────────────────────────────────────────────────────┐  |
|  │ ✅ 提供済み                                         │  |
|  │ プリン（ご本人希望により）                          │  |
|  │ 記録者: 佐藤一郎                                    │  |
|  │ [📋 詳細を確認]                                     │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
|  🌙 夕食 (18:00)                                         |
|  ┌────────────────────────────────────────────────────┐  |
|  │ ⏳ 未提供                                           │  |
|  │ 予定: らっきょう（冷）                              │  |
|  └────────────────────────────────────────────────────┘  |
|                                                          |
+----------------------------------------------------------+
|    📋 記録閲覧    │    ✏️ 記録入力    │    👨‍👩‍👧 家族    │  |
+----------------------------------------------------------+
```

### 5.3 Botハック連携

スタッフが「間食」を入力した場合（既存のBot連携ハック発動時）：
- タイムラインに「間食提供（⚠️重要）」として自動表示
- `isImportant === "重要"` のレコードを検出してハイライト

### 5.4 ステータス表示

| ステータス | アイコン | 説明 |
|-----------|---------|------|
| 完了 | ✅ | 実績記録済み |
| 提供済み | ✅ | 間食等、簡易記録 |
| 未提供 | ⏳ | まだ実績記録なし |
| 指示あり | 📋 | 家族からの指示が登録済み |

---

## 6. データモデル設計

### 6.1 既存FamilyRequestとの統合

既存の`FamilyRequest`型を拡張し、構造化入力に対応します。

```typescript
// 既存（汎用的な要望）
interface FamilyRequest {
  id: string;
  userId: string;
  residentId: string;
  category: "meal" | "daily_life" | "medical" | "recreation" | "communication" | "other";
  content: string;           // 自由記述
  priority: "low" | "medium" | "high";
  status: "pending" | "reviewed" | "implemented";
  attachments?: string[];
  createdAt: Timestamp;
  updatedAt: Timestamp;
}

// 新規追加（構造化されたケア指示）
interface CareInstruction {
  id: string;
  userId: string;            // ご家族ID
  residentId: string;        // 入居者ID

  // 対象指定
  targetDate: string;        // "2025-12-14"
  mealTime: "breakfast" | "lunch" | "dinner" | "snack";

  // メニュー・指示内容
  menuName: string;          // "キウイ"
  processingDetail: string;  // 詳細指示（必須・長文OK）

  // 条件付きロジック（オプション）
  conditions?: {
    trigger: "leftover" | "poor_condition" | "no_appetite" | "after_rehab";
    action: "reserve_snack" | "reduce_amount" | "cancel" | "alternative";
  }[];

  // 優先度
  priority: "normal" | "critical";  // critical = 絶対厳守

  // ステータス
  status: "pending" | "acknowledged" | "completed";

  // メタ情報
  createdAt: Timestamp;
  updatedAt: Timestamp;
}
```

### 6.2 Firestoreコレクション構成

```
firestore/
├── family_requests/           # 既存：汎用的な要望
│   └── {requestId}
├── care_instructions/         # 新規：構造化されたケア指示
│   └── {instructionId}
└── plan_data/                 # 既存：同期済み記録データ
    └── {recordId}
```

---

## 7. ルーティング設計

### 7.1 新規追加パス

| パス | コンポーネント | 説明 |
|------|---------------|------|
| `/family` | `FamilyDashboard` | 家族ホーム（タイムライン） |
| `/family/evidence/:date` | `EvidenceMonitor` | エビデンス・モニター |
| `/family/request` | `RequestBuilder` | ケア仕様ビルダー |
| `/family/request/:id` | `RequestBuilder` | 既存指示の編集 |

### 7.2 フッターナビゲーション拡張

既存の2タブから3タブに拡張：

```
| 📋 記録閲覧 | ✏️ 記録入力 | 👨‍👩‍👧 家族 |
```

---

## 8. 実装ファイル構成

```
frontend/src/
├── pages/
│   ├── family/
│   │   ├── FamilyDashboard.tsx    # View C: 家族ホーム
│   │   ├── EvidenceMonitor.tsx    # View A: エビデンス・モニター
│   │   └── RequestBuilder.tsx     # View B: ケア仕様ビルダー
├── components/
│   ├── family/
│   │   ├── EvidenceCard.tsx       # 予実対比カード
│   │   ├── TimelineItem.tsx       # タイムラインアイテム
│   │   ├── PresetButton.tsx       # プリセットボタン
│   │   └── ConditionBuilder.tsx   # 条件ロジックビルダー
├── data/
│   └── demoFamilyData.ts          # デモ用モックデータ
├── hooks/
│   └── useCareInstructions.ts     # 指示データ取得フック
└── types/
    └── family.ts                  # 家族向け型定義
```

---

## 9. デモ用モックデータ

蒲池様のFAX内容に基づく初期データ：

```typescript
// src/data/demoFamilyData.ts
export const DEMO_CARE_INSTRUCTIONS: CareInstruction[] = [
  {
    id: "demo-001",
    userId: "family-kamachi",
    residentId: "resident-kinue",
    targetDate: "2025-12-14",
    mealTime: "lunch",
    menuName: "キウイ",
    processingDetail:
      "輪切り4等分をさらに半分に切ってください。\n" +
      "皮は必ず剥いてください。\n" +
      "種が多い部分は避けてください。",
    conditions: [
      { trigger: "leftover", action: "reserve_snack" }
    ],
    priority: "critical",
    status: "completed",
    createdAt: /* ... */,
    updatedAt: /* ... */,
  },
  // ... 柿、らっきょう等のデモデータ
];
```

---

## 10. 開発優先度

| 優先度 | 項目 | 理由 |
|--------|------|------|
| **高** | View C: 家族ホーム | 既存データで動作確認可能 |
| **高** | View A: エビデンス・モニター | デモのインパクト大 |
| **中** | View B: ケア仕様ビルダー | 新規API不要（Firestoreのみ） |
| **低** | プリセット管理画面 | 管理者機能は後回し |

---

## 11. 関連ドキュメント

| ドキュメント | 内容 |
|--------------|------|
| [ARCHITECTURE.md](./ARCHITECTURE.md) | システム全体設計（Flow C追記予定） |
| [API_SPEC.md](./API_SPEC.md) | API仕様（submitFamilyRequest等） |
| [BUSINESS_RULES.md](./BUSINESS_RULES.md) | Bot連携ハック仕様 |
| [CURRENT_STATUS.md](./CURRENT_STATUS.md) | 現在の進捗 |

---

## 12. 実装状況

### Phase 7.0: 家族向け機能（Flow C拡張） ✅ 完了

| タスク | 状態 |
|--------|------|
| UX設計書作成（FAMILY_UX_DESIGN.md） | ✅ 完了 |
| ARCHITECTURE.md更新（Flow C詳細追記） | ✅ 完了 |
| 家族向け型定義（frontend/src/types/family.ts） | ✅ 完了 |
| デモ用モックデータ（frontend/src/data/demoFamilyData.ts） | ✅ 完了 |
| フッターナビ3タブ化（FooterNav.tsx） | ✅ 完了 |
| Layoutコンポーネント拡張（ヘッダー対応） | ✅ 完了 |
| View C: 家族ホーム（FamilyDashboard.tsx） | ✅ 完了 |
| View A: エビデンス・モニター（EvidenceMonitor.tsx） | ✅ 完了 |
| View B: ケア仕様ビルダー（RequestBuilder.tsx） | ✅ 完了 |
| ルーティング追加（App.tsx） | ✅ 完了 |

### Phase 7.1: 予実管理（Plan/Result連携） ✅ 完了

> **詳細設計**: [PLAN_RESULT_MANAGEMENT.md](./PLAN_RESULT_MANAGEMENT.md)

| タスク | 状態 |
|--------|------|
| 設計書作成（PLAN_RESULT_MANAGEMENT.md） | ✅ 完了 |
| 食事時間マッピングユーティリティ作成 | ✅ 完了 |
| MealResult型定義追加 | ✅ 完了 |
| useFamilyMealRecordsフック作成 | ✅ 完了 |
| EvidenceMonitor修正（実データ取得） | ✅ 完了 |
| FamilyDashboard修正（実データ反映） | ✅ 完了 |

**予実管理データフロー**:
```
食事入力(スタッフ) → Sheet B → 同期(15分毎) → Firestore plan_data/
                                                    ↓
家族ビュー → useFamilyMealRecords → 日付+食事時間でフィルタ → 表示
                                                    ↑
家族指示(Plan) → モックデータ (将来: Firestore care_instructions/)
```

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-15 | 初版作成（3ビュー設計・データモデル定義） |
| 2025-12-15 | Phase 7.0 実装完了・実装状況セクション追加 |
| 2025-12-15 | Phase 7.1 予実管理実装完了 |
