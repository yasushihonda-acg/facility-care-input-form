---
status: working
scope: feature
owner: core-team
last_reviewed: 2025-12-20
---

# スタッフ用記録入力フォーム リデザイン仕様書

> **Phase 15**: スタッフ用記録入力フォームの統一化
>
> **最終更新**: 2025年12月19日

---

## 1. 背景と目的

### 1.1 現状の課題

現在のスタッフ用記録入力画面（`/staff/input/meal`）には2つのタブが存在:

| タブ | 内容 | 問題点 |
|------|------|--------|
| **食事タブ** | 主食・副食・注入など詳細な食事記録 | 本施設では使用しない項目が多い |
| **品物から記録タブ** | 品物リストから間食記録 | 必要な機能だが独立している |

また、家族連絡詳細（`/staff/family-messages/:id`）の「提供・摂食を記録」ボタンは、簡易的なモーダルでUIが統一されていない。

### 1.2 目的

- **食事タブを削除**し、「品物から記録」のみにシンプル化
- **家族連絡詳細からの記録フォーム**を統一されたダイアログに変更
- **フォーム項目を整理**し、ユーザビリティを向上

---

## 2. 新設計概要

### 2.1 画面構成

```
変更前:
/staff/input/meal
├── [食事] タブ（主食・副食・注入など）← 削除
└── [品物から記録] タブ

変更後:
/staff/input/meal
└── 品物から記録（タブなし・直接表示）
    └── 統一フォーム（品物選択 + 共通項目）
```

### 2.2 フォーム表示方式

| 画面 | パス | 表示方式 | 備考 |
|------|------|----------|------|
| 記録入力 | `/staff/input/meal` | 全画面（直接表示） | タブなし |
| 家族連絡詳細 | `/staff/family-messages/:id` | **ダイアログ** | 品物自動選択済み |

---

## 3. 統一フォーム設計

### 3.1 フォーム項目

| # | 項目名 | 表示 | 必須 | 型 | 備考 |
|---|--------|------|------|-----|------|
| 1 | 入力者（あなた）は？ | ✅ | * | テキスト | スタッフ名入力 |
| 2 | 施設名 | ❌ 非表示 | - | - | マスター設定からデフォルト値使用 |
| 3 | 利用者名 | ❌ 非表示 | - | - | マスター設定からデフォルト値使用 |
| 4 | デイサービス利用中？ | ✅ | * | ラジオ | はい/いいえ |
| 5 | どこのデイサービス？ | ✅ 条件付き | * | セレクト | #4が「はい」の場合のみ |
| 6 | **品物選択・提供記録** | ✅ | - | カード | メイン入力エリア |
| 6a | └ 提供数 | ✅ | * | 数値 | 品物単位で入力 |
| 6b | └ 摂食した割合 | ✅ | * | 数値(0-10) | **Phase 15.6**: 絵文字→数値に変更 |
| 6c | └ 残った分への対応 | ✅ 条件付き | * | ラジオ | **Phase 15.6**: 6b<10の場合のみ |
| 7 | 間食について補足 | ✅ | - | テキストエリア | 自由記入 |
| 8 | 特記事項 | ✅ | - | テキストエリア | 【ケアに関すること】【ACPiece】 |
| 9 | 重要特記事項に反映？ | ✅ | * | ラジオ | 重要/重要ではない |
| 10 | 写真アップロード | ✅ | - | ファイル | 任意 |

### 3.2 削除する項目（旧食事タブ）

以下の項目は削除:

- ~~食事はいつのことですか？~~（朝食/昼食/夕食/間食）
- ~~主食の摂取量は何割ですか？~~
- ~~副食の摂取量は何割ですか？~~
- ~~注入の種類は？~~
- ~~注入量は？~~

### 3.3 隠し項目（Sheet B書き込み用）

以下の項目はUIに表示せず、マスター設定からデフォルト値を使用:

| 項目 | 保存先 | 値の取得元 |
|------|--------|-----------|
| facility | Sheet B | `settings.defaultFacility` |
| residentName | Sheet B | `settings.defaultResidentName` |
| residentId | Firestore | 固定値 `resident-001` |

---

## 4. UIデザイン

### 4.1 記録入力ページ（`/staff/input/meal`）

```
┌────────────────────────────────────────┐
│ ← 記録入力                    ⚙️ (admin) │  ← ヘッダー
├────────────────────────────────────────┤
│                                        │
│  入力者（あなた）は？ *               │
│  ┌──────────────────────────────────┐ │
│  │ お名前を入力                      │ │
│  └──────────────────────────────────┘ │
│                                        │
│  デイサービスの利用中ですか？ *       │
│  ( ) 利用中  (●) 利用中ではない       │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │ どこのデイサービス？ *（条件付き）│ │  ← 「利用中」選択時のみ
│  └──────────────────────────────────┘ │
├────────────────────────────────────────┤
│                                        │
│  📦 品物から記録                       │
│  品物を選んで提供記録を入力            │
│                                        │
│  ┌── ⭐ 今日提供予定 ────────────────┐ │
│  │ ⭐ みかん（愛媛産）               │ │
│  │    残り 5個 ┃ 期限 12/25          │ │
│  │    📅 12/19 (今日)                │ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  ┌── ⚠️ 期限が近い ─────────────────┐ │
│  │ ⚠️ バナナ                         │ │
│  │    残り 3本 ┃ 期限 12/20 (あと1日)│ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  ┌── 🟢 その他の品物 ────────────────┐ │
│  │ 🟢 羊羹（とらや）                 │ │
│  │    残り 2切 ┃ 期限 12/30          │ │
│  │    💬「1日1切れまで」             │ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
├────────────────────────────────────────┤
│                                        │
│  間食について補足（自由記入）          │
│  ┌──────────────────────────────────┐ │
│  │ 施設のおやつも少し召し上がりまし  │ │
│  │ た                                │ │
│  └──────────────────────────────────┘ │
│                                        │
│  特記事項                              │
│  ┌──────────────────────────────────┐ │
│  │ 【ケアに関すること】               │ │
│  │                                   │ │
│  │ 【ACPiece】                        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  重要特記事項に反映？ *               │
│  ( ) 重要  (●) 重要ではない           │
│                                        │
│  写真アップロード                      │
│  [ファイル選択] 選択されていません     │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │           記録を送信               │ │  ← メインボタン
│  └──────────────────────────────────┘ │
│                                        │
└────────────────────────────────────────┘
```

### 4.2 家族連絡詳細からのダイアログ

「提供・摂食を記録する」ボタンをクリックすると、**ダイアログ**で同様のフォームを表示。
ただし、クリックした品物が**自動選択済み**。

```
┌────────────────────────────────────────┐
│                                        │
│   ┌──────────────────────────────┐    │
│   │ 提供・摂食を記録          ✕ │    │  ← ダイアログヘッダー
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  📦 みかん（愛媛産）         │    │  ← 選択済み品物
│   │  残り: 5個 ┃ 期限: 12/25     │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  入力者（あなた）は？ *     │    │
│   │  ┌────────────────────────┐ │    │
│   │  │ お名前を入力            │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  デイサービス利用中？ *     │    │
│   │  ( ) はい  (●) いいえ       │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  提供数 *                    │    │
│   │  [  1  ] 個                  │    │
│   │                              │    │
│   │  摂食状況                    │    │
│   │  [😋完食][😊ほぼ][😐半分]   │    │
│   │  [😕少し][😞なし]            │    │
│   │                              │    │
│   │  メモ（任意）                │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  間食について補足            │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  特記事項                    │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  重要特記事項に反映？ *     │    │
│   │  ( ) 重要  (●) 重要ではない │    │
│   │                              │    │
│   │  写真アップロード            │    │
│   │  [ファイル選択]              │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │  [キャンセル]   [記録を保存] │    │
│   └──────────────────────────────┘    │
│                                        │
└────────────────────────────────────────┘
```

---

## 5. データフロー

### 5.1 送信時のデータ構造

```typescript
interface StaffRecordSubmitRequest {
  // 必須（フォームから入力）
  staffName: string;           // 入力者名
  dayServiceUsage: '利用中' | '利用中ではない';
  isImportant: '重要' | '重要ではない';

  // 条件付き必須
  dayServiceName?: string;     // デイサービス利用中の場合

  // 隠し項目（マスター設定から自動取得）
  facility: string;            // 施設名
  residentName: string;        // 利用者名
  residentId: string;          // resident-001 固定

  // 品物記録（複数可）
  snackRecords: SnackRecord[];

  // オプション
  snack?: string;              // 間食について補足
  note?: string;               // 特記事項
  photo?: File;                // 写真
}
```

### 5.2 Sheet B反映項目

| Sheet B列 | データソース |
|-----------|-------------|
| 入力者名 | `staffName` |
| 施設名 | マスター設定デフォルト |
| 利用者名 | マスター設定デフォルト |
| デイサービス利用 | `dayServiceUsage` |
| デイサービス名 | `dayServiceName`（利用中の場合） |
| 間食について | `snackRecords` → テキスト生成 + `snack` |
| 特記事項 | `note` |
| 重要特記事項 | `isImportant` |

### 5.3 API呼び出しフロー

```
[記録を送信] クリック
    │
    ├─→ 各 snackRecord について:
    │       recordConsumptionLog API（consumption_log記録）
    │
    └─→ submitMealRecord API（recordMode: 'snack_only'）
            └─→ Sheet B 書き込み
```

---

## 6. 実装計画

### 6.1 Phase分割

| Phase | 内容 | 影響ファイル |
|-------|------|-------------|
| **15.1** | フォーム項目整理・タブ削除 | `MealInputPage.tsx`, `MealInputTabs.tsx` |
| **15.2** | 統一フォームコンポーネント作成 | `StaffRecordForm.tsx`（新規） |
| **15.3** | 家族連絡詳細のダイアログ化 | `FamilyMessageDetail.tsx`, `StaffRecordDialog.tsx`（新規） |
| **15.4** | API連携・Sheet B対応 | `submitMealRecord.ts` |
| **15.5** | E2Eテスト | `staff-record.spec.ts`（新規） |

### 6.2 Phase 15.1: フォーム項目整理・タブ削除

**変更内容**:
1. `MealInputTabs.tsx` を削除（タブ不要）
2. `MealInputPage.tsx` から食事フォーム関連コードを削除
3. `ItemBasedSnackRecord` をメインコンテンツとして直接表示
4. 共通項目（入力者、デイサービス、特記事項など）をページ上部/下部に配置

**削除対象**:
- 食事時間帯選択（朝食/昼食/夕食/間食）
- 主食摂取量
- 副食摂取量
- 注入の種類
- 注入量

### 6.3 Phase 15.2: 統一フォームコンポーネント

**新規ファイル**: `frontend/src/components/staff/StaffRecordForm.tsx`

```typescript
interface StaffRecordFormProps {
  // 品物が事前選択されている場合（家族連絡詳細から）
  preSelectedItem?: CareItem;
  // 送信成功時のコールバック
  onSuccess?: () => void;
  // ダイアログモード
  isDialog?: boolean;
}
```

**機能**:
- 入力者名、デイサービス選択
- 品物リスト表示（preSelectedItemがある場合は固定）
- 間食補足、特記事項、重要フラグ、写真アップロード
- バリデーション

### 6.4 Phase 15.3: 家族連絡詳細のダイアログ化

**変更内容**:
1. `FamilyMessageDetail.tsx` の `ConsumptionRecordModal` を削除
2. 新しい `StaffRecordDialog.tsx` に置き換え
3. クリックした品物を `preSelectedItem` として渡す

**新規ファイル**: `frontend/src/components/staff/StaffRecordDialog.tsx`

```typescript
interface StaffRecordDialogProps {
  isOpen: boolean;
  onClose: () => void;
  item: CareItem;  // 自動選択される品物
  onSuccess?: () => void;
}
```

### 6.5 Phase 15.4: API連携

**変更内容**:
- `submitMealRecord` APIの `recordMode: 'snack_only'` を活用
- 不要なフィールド（mealTime, mainDishRatio等）を送信しない
- 写真アップロードの連携（既存の `uploadCareImage` APIを使用）

### 6.6 Phase 15.5: E2Eテスト

**テストケース**:
- STAFF-001: 入力者名必須バリデーション
- STAFF-002: デイサービス選択時の条件付き必須
- STAFF-003: 品物選択 → 提供記録入力 → 送信
- STAFF-004: 家族連絡詳細からダイアログ表示
- STAFF-005: 品物自動選択の確認
- STAFF-006: 複数品物の同時記録
- STAFF-007: 特記事項・重要フラグの反映
- STAFF-008: 写真アップロード

---

## 7. 移行計画

### 7.1 後方互換性

- 旧エンドポイント `/staff/input/meal` はそのまま維持
- URLを変更せず、UI/UXのみ改善
- 既存の `snackRecords` 形式を継続使用

### 7.2 デプロイ手順

1. Phase 15.1-15.4 を実装
2. ローカルでE2Eテスト実行
3. 本番デプロイ（Firebase Hosting + Functions）
4. 本番E2Eテスト実行

---

## 8. 関連ドキュメント

- [ITEM_BASED_SNACK_RECORD_SPEC.md](./ITEM_BASED_SNACK_RECORD_SPEC.md) - 品物起点の間食記録（Phase 13）
- [SNACK_RECORD_INTEGRATION_SPEC.md](./SNACK_RECORD_INTEGRATION_SPEC.md) - 間食記録連携
- [MEAL_INPUT_FORM_SPEC.md](./MEAL_INPUT_FORM_SPEC.md) - 旧食事入力フォーム仕様
- [VIEW_ARCHITECTURE_SPEC.md](./VIEW_ARCHITECTURE_SPEC.md) - View構成・ルーティング

---

## 9. Phase 15.6: 摂食状況入力の改善

### 9.1 背景

現在の摂食状況入力は絵文字ボタン（😋完食 / 😊ほぼ完食 / 😐半分 / 😕少し / 😞なし）の5段階選択。
これを**0〜10の数値入力**に変更し、より細かい記録を可能にする。

また、残った分への対応（破棄、保存等）を記録する新フィールドを追加。

### 9.2 摂食状況入力の変更

**変更前**:
```
摂食状況
[😋完食][😊ほぼ][😐半分][😕少し][😞なし]
```

**変更後**:
```
摂食した割合 *
[  7  ] / 10  ← 数値入力（0〜10）
```

| 入力値 | 意味 | 旧表示との対応 |
|--------|------|----------------|
| 10 | 完食（100%） | 😋 完食 |
| 8-9 | ほぼ完食（80-90%） | 😊 ほぼ完食 |
| 5-7 | 半分程度（50-70%） | 😐 半分 |
| 1-4 | 少し（10-40%） | 😕 少し |
| 0 | 食べなかった（0%） | 😞 なし |

### 9.3 残った分への対応（新フィールド）

摂食した割合が10未満（残りがある場合）のみ表示される条件付きフィールド。

**選択肢**:

| 値 | ラベル | 説明 |
|----|--------|------|
| `discarded` | 破棄した | 食べ残しを廃棄 |
| `stored` | 保存した | 冷蔵庫等に保管 |
| `other` | その他 | 自由記入で詳細入力 |

※ 施設入居者向けのため「持ち帰り」は対象外

### 9.4 UIデザイン（ダイアログ）

```
┌──────────────────────────────────────┐
│                                      │
│  提供数 *                            │
│  [  1  ] 個                          │
│                                      │
│  摂食した割合 *                       │
│  [  7  ] / 10                        │
│  ────────●──── (スライダー補助)      │
│                                      │
│  残った分への対応 *    ← 10未満の場合のみ │
│  ( ) 破棄した                        │
│  ( ) 保存した                        │
│  ( ) その他 → [          ]           │
│                                      │
│  メモ（任意）                        │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

### 9.5 データ構造変更

```typescript
// 変更前
interface SnackRecord {
  consumptionStatus: 'full' | 'most' | 'half' | 'little' | 'none';
  consumptionRate: number;  // 0-100
  // ...
}

// 変更後
interface SnackRecord {
  consumptionRate: number;  // 0-100（0〜10入力 × 10で計算）
  remainingHandling?: RemainingHandling;  // 残った分への対応（10未満の場合）
  remainingHandlingOther?: string;        // その他の場合の詳細
  // ...
}

type RemainingHandling = 'discarded' | 'stored' | 'other';
```

### 9.6 Sheet B反映

| 項目 | Sheet B列 | 値 |
|------|-----------|-----|
| 摂食割合 | 間食について（補足） | 「品名 提供数（〇割）」形式 |
| 残り対応 | 間食について（補足） | 「残り：破棄」等を追記 |

**出力例**:
```
みかん 2個（7割）、残り：保存した
```

### 9.7 実装ファイル

| ファイル | 変更内容 |
|----------|----------|
| `StaffRecordDialog.tsx` | 数値入力UI、残り対応フィールド追加 |
| `consumptionLog.ts` | RemainingHandling型追加 |
| `mealForm.ts` | SnackRecord型更新 |
| `submitMealRecord.ts` | テキスト生成ロジック更新 |

---

## 10. Phase 15.7: 残り対応による在庫・統計の分離計算

### 10.1 背景と課題

Phase 15.6で「残った分への対応」フィールド（破棄/保存/その他）を追加しましたが、現在の実装では**在庫計算に反映されていません**。

**現状の問題**:

```
例: 羊羹 現在10切れ → 5切れ提供 → 摂食7/10 → 「破棄した」

現状の計算:
  消費量 = 5 × 0.7 = 3.5切れ（食べた分のみ）
  残量 = 10 - 3.5 = 6.5切れ ← 問題！破棄したのに在庫に残っている
```

### 10.2 設計方針

**2つの数量を分離管理**:

| 概念 | 用途 | 計算基準 |
|------|------|----------|
| **在庫消費量** (inventoryDeducted) | 在庫から引く量 | 残り対応で変動 |
| **摂食量** (consumedQuantity) | 統計・傾向分析 | 常に「実際に食べた量」 |

### 10.3 残り対応別の計算ルール

| 残り対応 | 在庫消費量 | 摂食量 | 廃棄量 |
|----------|-----------|--------|--------|
| **破棄した** (discarded) | 提供量 | 食べた分 | 残り分 |
| **保存した** (stored) | 食べた分 | 食べた分 | 0 |
| **その他** (other) | 食べた分 | 食べた分 | 0 |
| **完食** (rate=10) | 提供量 | 提供量 | 0 |

### 10.4 計算式

```typescript
// Phase 15.7: 残り対応による在庫・統計分離計算
function calculateConsumptionAmounts(
  servedQuantity: number,        // 提供量
  consumptionRate: number,       // 摂食率 (0-100)
  remainingHandling?: RemainingHandling
): {
  consumedQuantity: number;      // 統計用：実際に食べた量
  inventoryDeducted: number;     // 在庫用：在庫から引く量
  wastedQuantity: number;        // 廃棄量（任意追跡）
} {
  // 実際に食べた量（統計用）
  const consumedQuantity = (consumptionRate / 100) * servedQuantity;

  // 残った量
  const remainingQuantity = servedQuantity - consumedQuantity;

  // 在庫から引く量（残り対応で分岐）
  let inventoryDeducted: number;
  let wastedQuantity: number;

  if (consumptionRate === 100) {
    // 完食：全量消費
    inventoryDeducted = servedQuantity;
    wastedQuantity = 0;
  } else if (remainingHandling === 'discarded') {
    // 破棄：提供量全てを在庫から引く
    inventoryDeducted = servedQuantity;
    wastedQuantity = remainingQuantity;
  } else {
    // 保存・その他：食べた分のみ在庫から引く
    inventoryDeducted = consumedQuantity;
    wastedQuantity = 0;
  }

  return { consumedQuantity, inventoryDeducted, wastedQuantity };
}
```

### 10.5 計算例

#### 例1: 破棄した場合

```
入力:
  - 現在残量: 10切れ
  - 提供数: 5切れ
  - 摂食割合: 7/10 (70%)
  - 残り対応: 破棄した

計算:
  - consumedQuantity = 5 × 0.7 = 3.5切れ（統計用）
  - wastedQuantity = 5 - 3.5 = 1.5切れ（廃棄）
  - inventoryDeducted = 5切れ（在庫から引く）
  - 記録後の残量 = 10 - 5 = 5切れ ✅
```

#### 例2: 保存した場合

```
入力:
  - 現在残量: 10切れ
  - 提供数: 5切れ
  - 摂食割合: 7/10 (70%)
  - 残り対応: 保存した

計算:
  - consumedQuantity = 5 × 0.7 = 3.5切れ（統計用）
  - wastedQuantity = 0
  - inventoryDeducted = 3.5切れ（在庫から引く）
  - 記録後の残量 = 10 - 3.5 = 6.5切れ ✅
```

### 10.6 データ構造拡張

#### ConsumptionLog（消費ログ）の拡張

```typescript
interface ConsumptionLog {
  // === 既存フィールド ===
  servedQuantity: number;        // 提供量
  consumedQuantity: number;      // 摂食量（統計用）
  consumptionRate: number;       // 摂食率 (0-100)

  // === Phase 15.6で追加 ===
  remainingHandling?: RemainingHandling;
  remainingHandlingOther?: string;

  // === Phase 15.7で追加 ===
  inventoryDeducted: number;     // 在庫から引いた量
  wastedQuantity?: number;       // 廃棄量（破棄時のみ）

  // === 既存フィールド（継続）===
  quantityBefore: number;        // 提供前残量
  quantityAfter: number;         // 提供後残量（= before - inventoryDeducted）
  // ...
}
```

### 10.7 統計への影響

#### 10.7.1 統計計算（変更なし）

統計は常に `consumedQuantity`（実際に食べた量）を使用するため、**統計計算ロジックは変更不要**。

```typescript
// FoodMaster / CareItem の統計更新
stats.totalConsumed += consumedQuantity;  // 実食量のみ加算
stats.avgConsumptionRate = (stats.totalConsumed / stats.totalServed) * 100;
```

#### 10.7.2 廃棄率の新規追跡（将来拡張）

廃棄量を追跡することで、将来的に「食品ロス分析」が可能:

```typescript
// FoodMaster.stats 拡張（将来）
stats: {
  totalServed: number;           // 累計提供回数
  totalConsumed: number;         // 累計消費量（実食）
  totalWasted: number;           // 累計廃棄量 ← 新規
  avgConsumptionRate: number;    // 平均摂食率
  wasteRate: number;             // 廃棄率 = totalWasted / totalServed
  // ...
}
```

### 10.8 UI表示の変更

#### 10.8.1 記録後の残量プレビュー

残り対応の選択に応じてリアルタイムで残量表示を更新:

```
┌──────────────────────────────────────┐
│  提供数: [  5  ] 切れ                │
│  摂食割合: [  7  ] / 10              │
│                                      │
│  残った分への対応 *                  │
│  (●) 破棄した                        │
│  ( ) 保存した                        │
│  ( ) その他                          │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 記録後の残量: 5.0切れ          │ │  ← 破棄なので提供量分引く
│  │ ⚠️ 廃棄: 1.5切れ               │ │  ← 廃棄量を表示
│  └────────────────────────────────┘ │
└──────────────────────────────────────┘
```

#### 10.8.2 品物詳細の消費ログ表示

消費ログに廃棄情報を追加表示:

```
📋 消費履歴
├─ 12/20 14:30 田中さん
│    提供: 5切れ → 摂食: 3.5切れ (70%)
│    🗑️ 残り1.5切れを破棄
│
├─ 12/19 10:00 鈴木さん
│    提供: 3切れ → 摂食: 2.1切れ (70%)
│    📦 残り0.9切れを保存
```

### 10.9 API変更

#### 10.9.1 recordConsumptionLog API

リクエストボディに `remainingHandling` を追加（既存）。
レスポンスに `inventoryDeducted`, `wastedQuantity` を追加。

```typescript
// リクエスト（Phase 15.6で対応済み）
interface RecordConsumptionLogRequest {
  itemId: string;
  servedQuantity: number;
  consumptionRate: number;        // 0-100（UI入力値×10）
  remainingHandling?: RemainingHandling;
  remainingHandlingOther?: string;
  // ...
}

// レスポンス（Phase 15.7で拡張）
interface RecordConsumptionLogResponse {
  success: boolean;
  logId: string;
  inventoryDeducted: number;      // 追加
  wastedQuantity: number;         // 追加
  quantityAfter: number;          // 更新後の残量
}
```

### 10.10 実装計画（✅完了）

| ステップ | 内容 | 影響ファイル | 状態 |
|----------|------|-------------|------|
| **15.7.1** | 計算関数追加 | `frontend/src/utils/consumptionCalc.ts`, `functions/src/utils/consumptionCalc.ts` | ✅ |
| **15.7.2** | StaffRecordDialog UI更新 | `StaffRecordDialog.tsx` | ✅ |
| **15.7.3** | ConsumptionLog型拡張 | `consumptionLog.ts`, `functions/src/types/index.ts` | ✅ |
| **15.7.4** | recordConsumptionLog API更新 | `functions/src/functions/consumptionLogs.ts` | ✅ |
| **15.7.5** | 在庫更新ロジック修正 | API内トランザクションで対応 | ✅ |
| **15.7.6** | E2Eテスト追加 | `staff-record-form.spec.ts` (STAFF-050〜053) | ✅ |
| **15.7.7** | APIペイロードに残り対応を含める | `StaffRecordDialog.tsx:141` | ✅ |
| **15.7.8** | snack_only時の二重記録防止 | `submitMealRecord.ts:416` | ✅ |

**コミット**: `ce07bf8` (Phase 15.7本体), `708fcc1` (ドキュメント)

### 10.11 E2Eテストケース

| ID | テストケース | 期待結果 |
|----|-------------|----------|
| STAFF-050 | 破棄選択時の残量プレビュー | 提供量全体が引かれる |
| STAFF-051 | 保存選択時の残量プレビュー | 食べた分のみ引かれる |
| STAFF-052 | 破棄後の品物残量確認 | 正しく減っている |
| STAFF-053 | 保存後の品物残量確認 | 正しく減っている |
| STAFF-054 | 消費ログに廃棄量が記録される | `wastedQuantity` が正しい |
| STAFF-055 | 統計は摂食量ベースで計算 | `avgConsumptionRate` が正しい |

### 10.12 後方互換性

- 既存の消費ログ（`remainingHandling` なし）は「保存した」扱いとして計算
- `inventoryDeducted` が未設定の既存データは `consumedQuantity` をフォールバック値として使用

```typescript
// 後方互換フォールバック
const inventoryDeducted = log.inventoryDeducted ?? log.consumedQuantity;
```

---

## 11. Phase 15.8: ベースページ簡素化

### 11.1 背景と課題

Phase 15の実装において、記録入力ページ（`/staff/input/meal`）に以下の問題が発生:

**問題点**:
1. ベースページとダイアログの両方に同じ入力項目が存在（入力者名、デイサービス、特記事項等）
2. ダイアログ内で既にAPI送信が完結しているのに、ベースページにも送信ボタンがある
3. ユーザーがどこで入力・送信すべきか混乱する

### 11.2 解決方針

**品物ブロック単位でのみ入力可能にする**:

- ベースページは**品物リスト表示のみ**
- 品物ブロックをクリック → ダイアログで全て入力・送信
- ベースページの外側の入力フォーム・送信ボタンを**削除**

### 11.3 変更前後の比較

**変更前**:
```
┌────────────────────────────────────┐
│ 入力者名 *                         │ ← 削除対象
│ デイサービス利用中？ *             │ ← 削除対象
├────────────────────────────────────┤
│  ⭐ 今日提供予定                   │
│  [品物ブロック] → ダイアログ       │
│  ...                               │
├────────────────────────────────────┤
│ 間食について補足                    │ ← 削除対象
│ 特記事項                           │ ← 削除対象
│ 重要特記事項                       │ ← 削除対象
│ 写真アップロード                   │ ← 削除対象
│ [記録を送信]                       │ ← 削除対象
└────────────────────────────────────┘
```

**変更後**:
```
┌────────────────────────────────────┐
│ ← 記録入力（ヘッダーのみ）         │
├────────────────────────────────────┤
│  ⭐ 今日提供予定                   │
│  [品物ブロック] → ダイアログ       │
│                                    │
│  ⚠️ 期限が近い                    │
│  [品物ブロック] → ダイアログ       │
│                                    │
│  🟢 その他の品物                   │
│  [品物ブロック] → ダイアログ       │
│                                    │
│  （送信ボタンなし）                │
└────────────────────────────────────┘
```

### 11.4 削除対象コード

**MealInputPage.tsx** から削除:

| 削除対象 | 行番号（概算） | 理由 |
|----------|---------------|------|
| `StaffRecordForm` インターフェース | L18-26 | 不要 |
| `initialForm` 定数 | L28-36 | 不要 |
| `form` state | L43 | 不要 |
| `errors` state | L44 | 不要 |
| `snackRecords` state | L50 | 不要 |
| `updateField` 関数 | L56-69 | 不要 |
| `validate` 関数 | L72-85 | 不要 |
| `handleSubmit` 関数 | L88-155 | 不要 |
| 共通項目（上部）セクション | L242-308 | 入力者名、デイサービス |
| 共通項目（下部）セクション | L319-391 | 補足、特記事項、写真 |
| 送信ボタン | L393-402 | 不要 |
| `<form>` タグ | L241, L403 | 不要 |

### 11.5 品物リストの表示順（確認済み）

既に `ItemBasedSnackRecord.tsx` で正しく実装:

1. **グループ優先順位**: 今日提供予定 → 期限が近い → その他
2. **各グループ内ソート**: 期限順（近い順）→ 送付日順（古い順）
3. **在庫フィルタ**: `status: ['pending', 'in_progress']` で在庫0は非表示

### 11.6 ダイアログの入力項目

`StaffRecordDialog.tsx` の項目:

| 項目 | 必須 | 備考 |
|------|------|------|
| 入力者名 | * | |
| デイサービス利用中？ | * | |
| デイサービス名 | 条件付き | 利用中の場合 |
| 提供数 | * | |
| 摂食した割合 | * | 0-10入力 |
| 残った分への対応 | 条件付き | 摂食<10の場合 |
| メモ | - | |
| 間食について補足 | - | |
| 特記事項 | - | |
| 重要特記事項 | * | |
| **写真アップロード** | - | **Phase 15.9で追加** ← セクション3.1で定義済みだが未実装だった |

### 11.7 E2Eテストケース

| ID | テストケース | 期待結果 |
|----|-------------|----------|
| STAFF-060 | ベースページに入力フォームがない | 入力者名フィールドが存在しない |
| STAFF-061 | ベースページに送信ボタンがない | 「記録を送信」ボタンが存在しない |
| STAFF-062 | 品物ブロッククリックでダイアログ表示 | ダイアログが開く |
| STAFF-063 | ダイアログから記録送信が完了 | 成功メッセージ表示 |

### 11.8 実装計画

| ステップ | 内容 | 状態 |
|----------|------|------|
| 15.8.1 | 設計ドキュメント更新 | ✅ |
| 15.8.2 | E2Eテスト追加（TDD） | 🔲 |
| 15.8.3 | MealInputPage.tsx 簡素化 | ✅ |
| 15.8.4 | ローカルテスト実行 | ✅ |
| 15.8.5 | コミット・Push | ✅ |
| 15.8.6 | 本番E2Eテスト | ✅ |

**コミット**: `14b61a8`

---

## 12. Phase 15.9: 写真アップロード機能追加

### 12.1 背景と課題

セクション3.1のフォーム項目一覧で「写真アップロード」（項目10）が定義されていたが、
StaffRecordDialogの実装時に漏れていた。

**現状**:
- バックエンドAPI `uploadCareImage`: ✅ 存在（Firebase Storage対応済み）
- フロントエンドAPI関数 `uploadCareImage()`: ✅ 存在（`api/index.ts:141`）
- 写真取得フック `useCarePhotos`, `useCarePhotoList`: ✅ 存在
- **StaffRecordDialog UI**: ❌ 未実装

### 12.2 設計方針

既存のAPIとフックを活用し、StaffRecordDialogに写真アップロードUIを追加する。

**写真アップロードのタイミング**:
- 記録保存時に写真も一緒にアップロード
- アップロード成功後、記録と写真を紐付け

### 12.3 UIデザイン

```
┌──────────────────────────────────────┐
│  ...（既存のフォーム項目）...          │
│                                      │
│  重要特記事項に反映？ *               │
│  ( ) 重要  (●) 重要ではない           │
│                                      │
│  ─────── 写真 ───────                 │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  📷 写真を追加                   │ │  ← タップでカメラ/ギャラリー
│  │                                │ │
│  │  [プレビュー画像]               │ │  ← 選択後に表示
│  │  × 削除                        │ │
│  └────────────────────────────────┘ │
│                                      │
│  ────────────────────────────────    │
│  記録後の残量: 5.0切れ                │
│                                      │
│  [キャンセル]        [記録を保存]     │
└──────────────────────────────────────┘
```

### 12.4 データフロー

```
[記録を保存] クリック
    │
    ├─→ 写真が選択されている場合:
    │       uploadCareImage API
    │       └─→ Firebase Storage にアップロード
    │       └─→ photoUrl を取得
    │
    └─→ recordConsumptionLog API（消費ログ記録）
            └─→ photoUrl を含めて送信
```

### 12.5 formData 拡張

```typescript
// 現在
interface FormData {
  staffName: string;
  dayServiceUsage: string;
  dayServiceName: string;
  servedQuantity: number;
  consumptionRateInput: number;
  remainingHandling: string;
  remainingHandlingOther: string;
  consumptionNote: string;
  snack: string;
  note: string;
  isImportant: string;
}

// Phase 15.9で追加
interface FormData {
  // ... 既存フィールド ...
  photo: File | null;       // 選択された写真ファイル
  photoPreview: string;     // プレビュー用Data URL
}
```

### 12.6 E2Eテストケース

| ID | テストケース | 期待結果 |
|----|-------------|----------|
| STAFF-070 | 写真アップロードエリアが表示される | ダイアログ内に写真追加ボタンがある |
| STAFF-071 | 写真選択後にプレビューが表示される | 選択した画像のプレビューが見える |
| STAFF-072 | 写真を削除できる | 削除ボタンでプレビューがクリアされる |
| STAFF-073 | 写真付きで記録を保存できる | 保存成功、写真がアップロードされる |

### 12.7 実装計画

| ステップ | 内容 | 状態 |
|----------|------|------|
| 15.9.1 | 設計ドキュメント更新 | ✅ |
| 15.9.2 | E2Eテスト追加（TDD） | 🔲 |
| 15.9.3 | StaffRecordDialog.tsx 写真UI実装 | 🔲 |
| 15.9.4 | アップロードロジック実装 | 🔲 |
| 15.9.5 | ローカルテスト実行 | 🔲 |
| 15.9.6 | コミット・Push | 🔲 |
| 15.9.7 | 本番E2Eテスト | 🔲 |

### 12.8 注意事項

- **ファイルサイズ制限**: 10MB以下（Firebase Storage制限）
- **対応形式**: JPEG, PNG, HEIC（iOS）
- **プレビュー生成**: FileReader.readAsDataURL()を使用
- **モバイル対応**: `accept="image/*"` で カメラ/ギャラリー選択を許可

---

## 13. 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-20 | Phase 15.9: 写真アップロード機能設計を追加（セクション3.1の項目10が未実装だった問題を修正） |
| 2025-12-20 | Phase 15.8実装完了: ベースページ簡素化（`14b61a8`） |
| 2025-12-20 | Phase 15.8: ベースページ簡素化設計を追加 |
| 2025-12-20 | Phase 15.7実装完了: APIペイロードにremainingHandling追加、二重記録防止ロジック追加 |
| 2025-12-20 | Phase 15.7: 残り対応による在庫・統計の分離計算設計を追加 |
| 2025-12-19 | Phase 15.6: 摂食状況を数値入力に変更、残り対応フィールド追加 |
| 2025-12-19 | 初版作成（Phase 15設計） |
