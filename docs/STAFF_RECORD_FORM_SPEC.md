# スタッフ用記録入力フォーム リデザイン仕様書

> **Phase 15**: スタッフ用記録入力フォームの統一化
>
> **最終更新**: 2025年12月19日

---

## 1. 背景と目的

### 1.1 現状の課題

現在のスタッフ用記録入力画面（`/staff/input/meal`）には2つのタブが存在:

| タブ | 内容 | 問題点 |
|------|------|--------|
| **食事タブ** | 主食・副食・注入など詳細な食事記録 | 本施設では使用しない項目が多い |
| **品物から記録タブ** | 品物リストから間食記録 | 必要な機能だが独立している |

また、家族連絡詳細（`/staff/family-messages/:id`）の「提供・摂食を記録」ボタンは、簡易的なモーダルでUIが統一されていない。

### 1.2 目的

- **食事タブを削除**し、「品物から記録」のみにシンプル化
- **家族連絡詳細からの記録フォーム**を統一されたダイアログに変更
- **フォーム項目を整理**し、ユーザビリティを向上

---

## 2. 新設計概要

### 2.1 画面構成

```
変更前:
/staff/input/meal
├── [食事] タブ（主食・副食・注入など）← 削除
└── [品物から記録] タブ

変更後:
/staff/input/meal
└── 品物から記録（タブなし・直接表示）
    └── 統一フォーム（品物選択 + 共通項目）
```

### 2.2 フォーム表示方式

| 画面 | パス | 表示方式 | 備考 |
|------|------|----------|------|
| 記録入力 | `/staff/input/meal` | 全画面（直接表示） | タブなし |
| 家族連絡詳細 | `/staff/family-messages/:id` | **ダイアログ** | 品物自動選択済み |

---

## 3. 統一フォーム設計

### 3.1 フォーム項目

| # | 項目名 | 表示 | 必須 | 型 | 備考 |
|---|--------|------|------|-----|------|
| 1 | 入力者（あなた）は？ | ✅ | * | テキスト | スタッフ名入力 |
| 2 | 施設名 | ❌ 非表示 | - | - | マスター設定からデフォルト値使用 |
| 3 | 利用者名 | ❌ 非表示 | - | - | マスター設定からデフォルト値使用 |
| 4 | デイサービス利用中？ | ✅ | * | ラジオ | はい/いいえ |
| 5 | どこのデイサービス？ | ✅ 条件付き | * | セレクト | #4が「はい」の場合のみ |
| 6 | **品物選択・提供記録** | ✅ | - | カード | メイン入力エリア |
| 6a | └ 提供数 | ✅ | * | 数値 | 品物単位で入力 |
| 6b | └ 摂食した割合 | ✅ | * | 数値(0-10) | **Phase 15.6**: 絵文字→数値に変更 |
| 6c | └ 残った分への対応 | ✅ 条件付き | * | ラジオ | **Phase 15.6**: 6b<10の場合のみ |
| 7 | 間食について補足 | ✅ | - | テキストエリア | 自由記入 |
| 8 | 特記事項 | ✅ | - | テキストエリア | 【ケアに関すること】【ACPiece】 |
| 9 | 重要特記事項に反映？ | ✅ | * | ラジオ | 重要/重要ではない |
| 10 | 写真アップロード | ✅ | - | ファイル | 任意 |

### 3.2 削除する項目（旧食事タブ）

以下の項目は削除:

- ~~食事はいつのことですか？~~（朝食/昼食/夕食/間食）
- ~~主食の摂取量は何割ですか？~~
- ~~副食の摂取量は何割ですか？~~
- ~~注入の種類は？~~
- ~~注入量は？~~

### 3.3 隠し項目（Sheet B書き込み用）

以下の項目はUIに表示せず、マスター設定からデフォルト値を使用:

| 項目 | 保存先 | 値の取得元 |
|------|--------|-----------|
| facility | Sheet B | `settings.defaultFacility` |
| residentName | Sheet B | `settings.defaultResidentName` |
| residentId | Firestore | 固定値 `resident-001` |

---

## 4. UIデザイン

### 4.1 記録入力ページ（`/staff/input/meal`）

```
┌────────────────────────────────────────┐
│ ← 記録入力                    ⚙️ (admin) │  ← ヘッダー
├────────────────────────────────────────┤
│                                        │
│  入力者（あなた）は？ *               │
│  ┌──────────────────────────────────┐ │
│  │ お名前を入力                      │ │
│  └──────────────────────────────────┘ │
│                                        │
│  デイサービスの利用中ですか？ *       │
│  ( ) 利用中  (●) 利用中ではない       │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │ どこのデイサービス？ *（条件付き）│ │  ← 「利用中」選択時のみ
│  └──────────────────────────────────┘ │
├────────────────────────────────────────┤
│                                        │
│  📦 品物から記録                       │
│  品物を選んで提供記録を入力            │
│                                        │
│  ┌── ⭐ 今日提供予定 ────────────────┐ │
│  │ ⭐ みかん（愛媛産）               │ │
│  │    残り 5個 ┃ 期限 12/25          │ │
│  │    📅 12/19 (今日)                │ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  ┌── ⚠️ 期限が近い ─────────────────┐ │
│  │ ⚠️ バナナ                         │ │
│  │    残り 3本 ┃ 期限 12/20 (あと1日)│ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  ┌── 🟢 その他の品物 ────────────────┐ │
│  │ 🟢 羊羹（とらや）                 │ │
│  │    残り 2切 ┃ 期限 12/30          │ │
│  │    💬「1日1切れまで」             │ │
│  │              [🍪 提供記録]        │ │
│  └──────────────────────────────────┘ │
│                                        │
├────────────────────────────────────────┤
│                                        │
│  間食について補足（自由記入）          │
│  ┌──────────────────────────────────┐ │
│  │ 施設のおやつも少し召し上がりまし  │ │
│  │ た                                │ │
│  └──────────────────────────────────┘ │
│                                        │
│  特記事項                              │
│  ┌──────────────────────────────────┐ │
│  │ 【ケアに関すること】               │ │
│  │                                   │ │
│  │ 【ACPiece】                        │ │
│  └──────────────────────────────────┘ │
│                                        │
│  重要特記事項に反映？ *               │
│  ( ) 重要  (●) 重要ではない           │
│                                        │
│  写真アップロード                      │
│  [ファイル選択] 選択されていません     │
│                                        │
│  ┌──────────────────────────────────┐ │
│  │           記録を送信               │ │  ← メインボタン
│  └──────────────────────────────────┘ │
│                                        │
└────────────────────────────────────────┘
```

### 4.2 家族連絡詳細からのダイアログ

「提供・摂食を記録する」ボタンをクリックすると、**ダイアログ**で同様のフォームを表示。
ただし、クリックした品物が**自動選択済み**。

```
┌────────────────────────────────────────┐
│                                        │
│   ┌──────────────────────────────┐    │
│   │ 提供・摂食を記録          ✕ │    │  ← ダイアログヘッダー
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  📦 みかん（愛媛産）         │    │  ← 選択済み品物
│   │  残り: 5個 ┃ 期限: 12/25     │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  入力者（あなた）は？ *     │    │
│   │  ┌────────────────────────┐ │    │
│   │  │ お名前を入力            │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  デイサービス利用中？ *     │    │
│   │  ( ) はい  (●) いいえ       │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  提供数 *                    │    │
│   │  [  1  ] 個                  │    │
│   │                              │    │
│   │  摂食状況                    │    │
│   │  [😋完食][😊ほぼ][😐半分]   │    │
│   │  [😕少し][😞なし]            │    │
│   │                              │    │
│   │  メモ（任意）                │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │                              │    │
│   │  間食について補足            │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  特記事項                    │    │
│   │  ┌────────────────────────┐ │    │
│   │  │                        │ │    │
│   │  └────────────────────────┘ │    │
│   │                              │    │
│   │  重要特記事項に反映？ *     │    │
│   │  ( ) 重要  (●) 重要ではない │    │
│   │                              │    │
│   │  写真アップロード            │    │
│   │  [ファイル選択]              │    │
│   │                              │    │
│   ├──────────────────────────────┤    │
│   │  [キャンセル]   [記録を保存] │    │
│   └──────────────────────────────┘    │
│                                        │
└────────────────────────────────────────┘
```

---

## 5. データフロー

### 5.1 送信時のデータ構造

```typescript
interface StaffRecordSubmitRequest {
  // 必須（フォームから入力）
  staffName: string;           // 入力者名
  dayServiceUsage: '利用中' | '利用中ではない';
  isImportant: '重要' | '重要ではない';

  // 条件付き必須
  dayServiceName?: string;     // デイサービス利用中の場合

  // 隠し項目（マスター設定から自動取得）
  facility: string;            // 施設名
  residentName: string;        // 利用者名
  residentId: string;          // resident-001 固定

  // 品物記録（複数可）
  snackRecords: SnackRecord[];

  // オプション
  snack?: string;              // 間食について補足
  note?: string;               // 特記事項
  photo?: File;                // 写真
}
```

### 5.2 Sheet B反映項目

| Sheet B列 | データソース |
|-----------|-------------|
| 入力者名 | `staffName` |
| 施設名 | マスター設定デフォルト |
| 利用者名 | マスター設定デフォルト |
| デイサービス利用 | `dayServiceUsage` |
| デイサービス名 | `dayServiceName`（利用中の場合） |
| 間食について | `snackRecords` → テキスト生成 + `snack` |
| 特記事項 | `note` |
| 重要特記事項 | `isImportant` |

### 5.3 API呼び出しフロー

```
[記録を送信] クリック
    │
    ├─→ 各 snackRecord について:
    │       recordConsumptionLog API（consumption_log記録）
    │
    └─→ submitMealRecord API（recordMode: 'snack_only'）
            └─→ Sheet B 書き込み
```

---

## 6. 実装計画

### 6.1 Phase分割

| Phase | 内容 | 影響ファイル |
|-------|------|-------------|
| **15.1** | フォーム項目整理・タブ削除 | `MealInputPage.tsx`, `MealInputTabs.tsx` |
| **15.2** | 統一フォームコンポーネント作成 | `StaffRecordForm.tsx`（新規） |
| **15.3** | 家族連絡詳細のダイアログ化 | `FamilyMessageDetail.tsx`, `StaffRecordDialog.tsx`（新規） |
| **15.4** | API連携・Sheet B対応 | `submitMealRecord.ts` |
| **15.5** | E2Eテスト | `staff-record.spec.ts`（新規） |

### 6.2 Phase 15.1: フォーム項目整理・タブ削除

**変更内容**:
1. `MealInputTabs.tsx` を削除（タブ不要）
2. `MealInputPage.tsx` から食事フォーム関連コードを削除
3. `ItemBasedSnackRecord` をメインコンテンツとして直接表示
4. 共通項目（入力者、デイサービス、特記事項など）をページ上部/下部に配置

**削除対象**:
- 食事時間帯選択（朝食/昼食/夕食/間食）
- 主食摂取量
- 副食摂取量
- 注入の種類
- 注入量

### 6.3 Phase 15.2: 統一フォームコンポーネント

**新規ファイル**: `frontend/src/components/staff/StaffRecordForm.tsx`

```typescript
interface StaffRecordFormProps {
  // 品物が事前選択されている場合（家族連絡詳細から）
  preSelectedItem?: CareItem;
  // 送信成功時のコールバック
  onSuccess?: () => void;
  // ダイアログモード
  isDialog?: boolean;
}
```

**機能**:
- 入力者名、デイサービス選択
- 品物リスト表示（preSelectedItemがある場合は固定）
- 間食補足、特記事項、重要フラグ、写真アップロード
- バリデーション

### 6.4 Phase 15.3: 家族連絡詳細のダイアログ化

**変更内容**:
1. `FamilyMessageDetail.tsx` の `ConsumptionRecordModal` を削除
2. 新しい `StaffRecordDialog.tsx` に置き換え
3. クリックした品物を `preSelectedItem` として渡す

**新規ファイル**: `frontend/src/components/staff/StaffRecordDialog.tsx`

```typescript
interface StaffRecordDialogProps {
  isOpen: boolean;
  onClose: () => void;
  item: CareItem;  // 自動選択される品物
  onSuccess?: () => void;
}
```

### 6.5 Phase 15.4: API連携

**変更内容**:
- `submitMealRecord` APIの `recordMode: 'snack_only'` を活用
- 不要なフィールド（mealTime, mainDishRatio等）を送信しない
- 写真アップロードの連携（既存の `uploadCareImage` APIを使用）

### 6.6 Phase 15.5: E2Eテスト

**テストケース**:
- STAFF-001: 入力者名必須バリデーション
- STAFF-002: デイサービス選択時の条件付き必須
- STAFF-003: 品物選択 → 提供記録入力 → 送信
- STAFF-004: 家族連絡詳細からダイアログ表示
- STAFF-005: 品物自動選択の確認
- STAFF-006: 複数品物の同時記録
- STAFF-007: 特記事項・重要フラグの反映
- STAFF-008: 写真アップロード

---

## 7. 移行計画

### 7.1 後方互換性

- 旧エンドポイント `/staff/input/meal` はそのまま維持
- URLを変更せず、UI/UXのみ改善
- 既存の `snackRecords` 形式を継続使用

### 7.2 デプロイ手順

1. Phase 15.1-15.4 を実装
2. ローカルでE2Eテスト実行
3. 本番デプロイ（Firebase Hosting + Functions）
4. 本番E2Eテスト実行

---

## 8. 関連ドキュメント

- [ITEM_BASED_SNACK_RECORD_SPEC.md](./ITEM_BASED_SNACK_RECORD_SPEC.md) - 品物起点の間食記録（Phase 13）
- [SNACK_RECORD_INTEGRATION_SPEC.md](./SNACK_RECORD_INTEGRATION_SPEC.md) - 間食記録連携
- [MEAL_INPUT_FORM_SPEC.md](./MEAL_INPUT_FORM_SPEC.md) - 旧食事入力フォーム仕様
- [VIEW_ARCHITECTURE_SPEC.md](./VIEW_ARCHITECTURE_SPEC.md) - View構成・ルーティング

---

## 9. Phase 15.6: 摂食状況入力の改善

### 9.1 背景

現在の摂食状況入力は絵文字ボタン（😋完食 / 😊ほぼ完食 / 😐半分 / 😕少し / 😞なし）の5段階選択。
これを**0〜10の数値入力**に変更し、より細かい記録を可能にする。

また、残った分への対応（破棄、保存、持ち帰り等）を記録する新フィールドを追加。

### 9.2 摂食状況入力の変更

**変更前**:
```
摂食状況
[😋完食][😊ほぼ][😐半分][😕少し][😞なし]
```

**変更後**:
```
摂食した割合 *
[  7  ] / 10  ← 数値入力（0〜10）
```

| 入力値 | 意味 | 旧表示との対応 |
|--------|------|----------------|
| 10 | 完食（100%） | 😋 完食 |
| 8-9 | ほぼ完食（80-90%） | 😊 ほぼ完食 |
| 5-7 | 半分程度（50-70%） | 😐 半分 |
| 1-4 | 少し（10-40%） | 😕 少し |
| 0 | 食べなかった（0%） | 😞 なし |

### 9.3 残った分への対応（新フィールド）

摂食した割合が10未満（残りがある場合）のみ表示される条件付きフィールド。

**選択肢**:

| 値 | ラベル | 説明 |
|----|--------|------|
| `discarded` | 破棄した | 食べ残しを廃棄 |
| `stored` | 保存した | 冷蔵庫等に保管 |
| `took_home` | 持ち帰り | 利用者が持ち帰り（デイサービス等） |
| `other` | その他 | 自由記入で詳細入力 |

### 9.4 UIデザイン（ダイアログ）

```
┌──────────────────────────────────────┐
│                                      │
│  提供数 *                            │
│  [  1  ] 個                          │
│                                      │
│  摂食した割合 *                       │
│  [  7  ] / 10                        │
│  ────────●──── (スライダー補助)      │
│                                      │
│  残った分への対応 *    ← 10未満の場合のみ │
│  ( ) 破棄した                        │
│  ( ) 保存した                        │
│  ( ) 持ち帰り                        │
│  ( ) その他 → [          ]           │
│                                      │
│  メモ（任意）                        │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

### 9.5 データ構造変更

```typescript
// 変更前
interface SnackRecord {
  consumptionStatus: 'full' | 'most' | 'half' | 'little' | 'none';
  consumptionRate: number;  // 0-100
  // ...
}

// 変更後
interface SnackRecord {
  consumptionRate: number;  // 0-100（0〜10入力 × 10で計算）
  remainingHandling?: RemainingHandling;  // 残った分への対応（10未満の場合）
  remainingHandlingOther?: string;        // その他の場合の詳細
  // ...
}

type RemainingHandling = 'discarded' | 'stored' | 'took_home' | 'other';
```

### 9.6 Sheet B反映

| 項目 | Sheet B列 | 値 |
|------|-----------|-----|
| 摂食割合 | 間食について（補足） | 「品名 提供数（〇割）」形式 |
| 残り対応 | 間食について（補足） | 「残り：破棄」等を追記 |

**出力例**:
```
みかん 2個（7割）、残り：保存した
```

### 9.7 実装ファイル

| ファイル | 変更内容 |
|----------|----------|
| `StaffRecordDialog.tsx` | 数値入力UI、残り対応フィールド追加 |
| `consumptionLog.ts` | RemainingHandling型追加 |
| `mealForm.ts` | SnackRecord型更新 |
| `submitMealRecord.ts` | テキスト生成ロジック更新 |

---

## 10. 変更履歴

| 日付 | 内容 |
|------|------|
| 2025-12-19 | Phase 15.6: 摂食状況を数値入力に変更、残り対応フィールド追加 |
| 2025-12-19 | 初版作成（Phase 15設計） |
