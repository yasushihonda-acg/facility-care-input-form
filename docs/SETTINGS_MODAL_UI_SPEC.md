# 設定モーダルUI改善仕様書

> **最終更新**: 2025年12月15日
>
> MealSettingsModal のボタン配置改善仕様

---

## 問題点

現在のUI:
```
┌──────────────────┐  ┌──────────────────┐
│      クリア       │  │       保存       │
└──────────────────┘  └──────────────────┘
```

**課題**:
1. 「クリア」と「保存」が並んでいると、「クリア」が「キャンセル」と誤解されやすい
2. ユーザーが誤って「クリア」を押して設定が全消去される危険性
3. 一般的なモーダルでは「キャンセル/保存」のペアが自然

---

## 改善仕様

### ボタン配置

```
┌──────────────────────────────────────────────┐
│           グローバル初期値設定                  │
├──────────────────────────────────────────────┤
│                                              │
│  [各入力フィールド...]                         │
│                                              │
│  ─────── 危険な操作 ───────                   │
│                                              │
│  🗑️ 全設定をクリア                            │  ← テキストリンク（赤色）
│                                              │
├──────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐ │
│  │    キャンセル      │  │       保存       │ │
│  └──────────────────┘  └──────────────────┘ │
└──────────────────────────────────────────────┘
```

### 変更内容

| 要素 | Before | After |
|------|--------|-------|
| 左ボタン | クリア | キャンセル |
| 右ボタン | 保存 | 保存（変更なし） |
| クリア機能 | フッターボタン | 本文下部のテキストリンク |
| クリア確認 | なし | 確認ダイアログ追加 |

### ボタン動作

| ボタン | 動作 |
|--------|------|
| キャンセル | モーダルを閉じる（変更を破棄、ローカル状態をリセット） |
| 保存 | 設定をFirestoreに保存してモーダルを閉じる |
| 全設定をクリア | 確認ダイアログ → 全設定を空にして保存 |

### キャンセル時の動作（重要）

**仕様**: キャンセルボタン押下時は、以下の状態をすべてリセットする：

1. **ローカル設定状態**: 元の設定値（props.settings）に戻す
2. **テスト状態**: 全てのテスト結果表示をクリア
3. **保存メッセージ**: 表示中のメッセージをクリア

**理由**: テストだけ実行して保存せずにキャンセルした場合、次回モーダル表示時に前回の入力値やテスト結果が残っていると混乱を招く。

**実装詳細**:
- `useEffect`で`isOpen`を監視し、モーダルが開いた時（`isOpen=true`）に`resetAllStates()`を実行
- Reactコンポーネントは`isOpen=false`でも破棄されずにメモリ上に残るため、`handleCancel`でのリセットだけでは不十分
- モーダルを開く度に必ずpropsの設定値で初期化されることを保証

```typescript
// MealSettingsModal.tsx
useEffect(() => {
  if (isOpen) {
    resetAllStates();  // モーダルが開いた時に状態をリセット
  }
}, [isOpen, settings]);
```

### クリア確認ダイアログ

```
┌─────────────────────────────────────┐
│  全設定をクリアしますか？              │
│                                     │
│  この操作は取り消せません。            │
│  全ての初期値設定が空になります。       │
│                                     │
│  ┌─────────────┐  ┌─────────────┐  │
│  │  キャンセル   │  │   クリア    │  │
│  └─────────────┘  └─────────────┘  │
└─────────────────────────────────────┘
```

---

## スタイル仕様

### キャンセルボタン
- 背景: 白 (`bg-white`)
- 枠線: グレー (`border-gray-300`)
- 文字: グレー (`text-gray-700`)
- ホバー: 薄いグレー背景 (`hover:bg-gray-100`)

### 保存ボタン
- 背景: 黄色 (`bg-yellow-500`)
- 文字: 黒 (`text-black`)
- ホバー: 濃い黄色 (`hover:bg-yellow-600`)

### クリアリンク
- 文字: 赤 (`text-red-500`)
- アイコン: ゴミ箱
- ホバー: 下線 (`hover:underline`)
- 配置: 本文エリア下部、左寄せ

---

## テスト送信機能 📋 計画中（Phase 5.8）

> **詳細設計**: [ADMIN_TEST_FEATURE_SPEC.md](./ADMIN_TEST_FEATURE_SPEC.md) を参照

### 概要

Webhook URLやDriveフォルダIDの設定を保存前にテストできる機能を追加。

### UI設計

```
┌──────────────────────────────────────────────────────────────┐
│           グローバル初期値設定                                  │
├──────────────────────────────────────────────────────────────┤
│                                                              │
│  📣 通知設定                                                  │
│  ──────────────────────────────────────────────────────────  │
│                                                              │
│  Google Chat Webhook URL（通常通知）                           │
│  ┌─────────────────────────────────────┐ ┌────────────────┐ │
│  │ https://chat.googleapis.com/...     │ │  テスト送信    │ │
│  └─────────────────────────────────────┘ └────────────────┘ │
│  ✅ テスト送信成功                                            │
│                                                              │
│  Google Chat Webhook URL（重要通知）                           │
│  ┌─────────────────────────────────────┐ ┌────────────────┐ │
│  │ https://chat.googleapis.com/...     │ │  テスト送信    │ │
│  └─────────────────────────────────────┘ └────────────────┘ │
│                                                              │
│  📷 写真アップロード設定                                       │
│  ──────────────────────────────────────────────────────────  │
│                                                              │
│  Google Drive フォルダID                                       │
│  ┌─────────────────────────────────────┐ ┌────────────────┐ │
│  │ 1ABC123xyz...                       │ │  接続テスト    │ │
│  └─────────────────────────────────────┘ └────────────────┘ │
│  ✅ フォルダにアクセス可能: ケア写真フォルダ                    │
│                                                              │
│  ─────── 危険な操作 ───────                                   │
│  🗑️ 全設定をクリア                                            │
│                                                              │
├──────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐                    ┌──────────────────┐│
│  │    キャンセル      │                    │       保存       ││
│  └──────────────────┘                    └──────────────────┘│
└──────────────────────────────────────────────────────────────┘
```

### テストボタン仕様

| ボタン | 対象フィールド | API | 説明 |
|--------|---------------|-----|------|
| テスト送信 | webhookUrl | `/testWebhook` | テストメッセージを送信 |
| テスト送信 | importantWebhookUrl | `/testWebhook` | テストメッセージを送信 |
| 接続テスト | driveUploadFolderId | `/testDriveAccess` | フォルダアクセス確認 |

### テスト結果表示

| 状態 | 表示 |
|------|------|
| 未テスト | 表示なし |
| テスト中 | 🔄 テスト中... (グレー) |
| 成功 | ✅ テスト送信成功 / ✅ フォルダにアクセス可能: {フォルダ名} (緑) |
| 失敗 | ❌ テスト失敗: {エラー内容} (赤) |

### クールダウン仕様

- テストボタン押下後、5秒間は再押下不可
- クールダウン中はボタンをdisabled表示
- 理由: API呼び出しの連打防止

### スタイル仕様

**テストボタン**:
- 背景: 薄い青 (`bg-blue-50`)
- 枠線: 青 (`border-blue-300`)
- 文字: 青 (`text-blue-600`)
- ホバー: 青背景 (`hover:bg-blue-100`)
- disabled: グレーアウト (`opacity-50 cursor-not-allowed`)

---

## 実装ファイル

- `frontend/src/components/MealSettingsModal.tsx`
- `frontend/src/services/adminTestService.ts` 📋 計画中
- `functions/src/functions/testWebhook.ts` 📋 計画中
- `functions/src/functions/testDriveAccess.ts` 📋 計画中

---

## 更新履歴

| 日付 | 内容 |
|------|------|
| 2025-12-15 | キャンセル時リセット: useEffectでisOpen監視による実装詳細追加 |
| 2025-12-15 | キャンセル時のリセット動作仕様を追加（テスト後キャンセル問題修正） |
| 2025-12-15 | Phase 5.8 テスト送信機能仕様追加 |
| 2025-12-15 | 初版作成 |
