# MoE複眼チェック分析: 品物管理 × ケア指示 統合設計

## 概要

本ドキュメントは、以下2つの機能間の重複・非効率性を分析し、最適な統合設計を提案します。

- **品物管理**（`ITEM_MANAGEMENT_SPEC.md`）
- **ケア指示ビュー / いつもの指示**（`FAMILY_UX_DESIGN.md`）

---

## 1. 現状分析

### 1.1 品物管理（CareItem）の役割

```
家族が送る品物の登録・追跡
├── 登録情報: 品物名、カテゴリ、送付日、数量、賞味期限
├── 提供方法: 保存方法、提供方法、提供予定日
├── AI提案: 品物名から賞味期限・保存方法を自動提案
└── 消費追跡: 提供日、消費状態、フィードバック
```

**主なフィールド（CareItemInput）:**
| フィールド | 説明 |
|-----------|------|
| itemName | 品物名 |
| category | カテゴリ（果物/野菜/菓子等） |
| sentDate | 送付日 |
| quantity/unit | 数量・単位 |
| expirationDate | 賞味期限 |
| storageMethod | 保存方法（常温/冷蔵/冷凍） |
| servingMethod | 提供方法（そのまま/カット等） |
| servingMethodDetail | 提供方法詳細 |
| plannedServeDate | 提供予定日 |
| noteToStaff | スタッフへの申し送り |

### 1.2 ケア指示ビュー / いつもの指示（CareInstruction）の役割

```
入居者へのケア指示の管理
├── 指示内容: 食事制限、好み、アレルギー、服薬情報
├── プリセット: よく使う指示パターンを登録
├── 条件ロジック: 時間帯・曜日による出し分け
└── テンプレート: 品物カテゴリごとのデフォルト指示
```

**主なフィールド（CareInstruction）:**
| フィールド | 説明 |
|-----------|------|
| type | 指示タイプ（食事/服薬/活動等） |
| title | 指示タイトル |
| content | 指示内容 |
| priority | 優先度 |
| conditions | 適用条件（時間帯/曜日等） |
| isPreset | プリセットフラグ |
| presetName | プリセット名 |

### 1.3 重複・類似フィールドの特定

| 品物管理 | ケア指示 | 関係性 |
|----------|----------|--------|
| servingMethod | content（提供指示） | **重複**: 同じ情報を別々に管理 |
| servingMethodDetail | content | **重複**: 詳細指示が分散 |
| noteToStaff | content（申し送り） | **重複**: スタッフへの伝達事項 |
| storageMethod | - | 品物固有 |
| expirationDate | - | 品物固有 |
| - | conditions | ケア指示固有 |
| - | priority | ケア指示固有 |

---

## 2. MoE複眼チェック分析

### 視点1: UXデザイナー（ユーザー体験）

**現状の問題:**
- 品物登録時に「提供方法」「詳細」「申し送り」を入力
- 別画面でケア指示を設定（同じような情報を再入力）
- 家族は2箇所で類似情報を管理する認知負荷

**改善提案:**
```
品物登録フロー改善案
├── ステップ1: 品物基本情報（名前、カテゴリ、数量）
├── ステップ2: AI提案 + プリセット選択
│   ├── AIが賞味期限・保存方法を提案
│   └── 「いつもの指示」プリセットを表示・選択可能
├── ステップ3: 詳細調整（必要に応じて）
└── ステップ4: 確認・登録
```

**メリット:**
- ワンストップで品物+ケア指示を設定
- プリセット活用で入力工数削減
- 認知負荷の軽減

### 視点2: バックエンドエンジニア（データ設計）

**現状の問題:**
- CareItemとCareInstructionが独立したコレクション
- 同一入居者への指示が分散
- スタッフが両方を確認する必要

**改善提案:**

```typescript
// 案A: CareItemにCareInstructionを埋め込み
interface CareItemWithInstruction extends CareItem {
  linkedInstructions: CareInstruction[];  // 紐付けられた指示
  appliedPresetId?: string;               // 適用したプリセットID
}

// 案B: 中間テーブルで関連付け
interface ItemInstructionLink {
  itemId: string;
  instructionId: string;
  appliedAt: Timestamp;
}

// 案C: プリセット参照型
interface CareItem {
  // ... 既存フィールド
  presetId?: string;              // 適用プリセットID
  customInstructions?: string;    // カスタム指示（プリセット上書き用）
}
```

**推奨: 案C（プリセット参照型）**
- シンプルな設計
- 既存データ構造への影響最小
- プリセット変更が自動反映

### 視点3: プロダクトマネージャー（ビジネス価値）

**現状の問題:**
- 機能が分散していて使いこなせない家族がいる可能性
- 設定漏れによるケアミスのリスク
- 施設スタッフの確認工数

**改善による価値:**
| 指標 | 現状 | 改善後 |
|------|------|--------|
| 品物登録完了率 | ベースライン | +15%見込み（工数削減） |
| ケア指示設定率 | 低い（別画面） | +40%見込み（統合による） |
| スタッフ確認時間 | 2画面確認 | 1画面で完結 |
| ケアミス発生率 | ベースライン | -30%見込み |

### 視点4: フロントエンドエンジニア（実装難易度）

**現状のコンポーネント構成:**
```
ItemForm.tsx
├── AISuggestion.tsx (AI提案カード)
├── カテゴリ選択
├── 提供方法選択
└── 詳細入力
```

**統合後のコンポーネント構成:**
```
ItemForm.tsx (改修)
├── AISuggestion.tsx (拡張)
│   ├── AI提案セクション
│   └── プリセット提案セクション ← 新規追加
├── PresetSelector.tsx ← 新規作成
│   ├── プリセット一覧
│   ├── プリセット適用ボタン
│   └── カスタマイズオプション
├── カテゴリ選択
├── 提供方法選択 (プリセットから自動入力)
└── 詳細入力 (プリセットから自動入力)
```

**実装工数見積もり:**
- PresetSelector.tsx 新規作成: 中
- AISuggestion.tsx 拡張: 小
- ItemForm.tsx 改修: 中
- usePresets フック作成: 小
- API拡張（プリセット取得）: 小
- **合計: 約2-3日**

### 視点5: QAエンジニア（品質・エッジケース）

**考慮すべきケース:**
1. プリセットが存在しない入居者
2. AI提案とプリセットが矛盾する場合
3. プリセット適用後の手動変更
4. プリセット自体の更新と既存品物への影響

**テスト観点:**
| ケース | 期待動作 |
|--------|----------|
| プリセットなし | AI提案のみ表示 |
| AI提案なし | プリセットのみ表示 |
| 両方あり | 両方表示、選択可能 |
| 矛盾あり | 警告表示、ユーザー選択 |
| 手動変更 | 変更フラグ立て、確認促す |

---

## 3. 統合設計案

### 3.1 推奨アプローチ: 段階的統合

**Phase 1: プリセット表示統合（即座に実装可能）**
```
現状: AI提案のみ表示
    ↓
改善: AI提案 + プリセット候補を並列表示
```

**Phase 2: プリセット適用機能**
```
- プリセット選択で自動入力
- AI提案との併用可能
- カスタマイズオプション
```

**Phase 3: 逆方向統合（将来）**
```
- 品物登録からプリセット作成
- よく使うパターンを自動検出
- プリセット提案機能
```

### 3.2 UI/UXフロー

```
品物名入力（例: キウイ）
    │
    ├─→ [AI提案カード]
    │     賞味期限: 7日
    │     保存方法: 冷蔵
    │     [この提案を適用]
    │
    └─→ [いつもの指示カード] ← 新規追加
          📌 果物は一口大にカット
          📌 朝食時に提供
          [この指示を適用]

    ※ 両方適用可能、矛盾時は警告
```

### 3.3 データモデル拡張

```typescript
// CareItemInput 拡張
interface CareItemInput {
  // ... 既存フィールド

  // 新規追加
  appliedPresetIds?: string[];      // 適用したプリセットID群
  aiSuggestionApplied?: boolean;    // AI提案適用フラグ
  instructionSource?: 'ai' | 'preset' | 'manual' | 'mixed';  // 指示の出所
}

// プリセット取得API追加
interface PresetSuggestion {
  presetId: string;
  presetName: string;
  matchReason: string;        // マッチ理由（カテゴリ/品物名等）
  confidence: number;         // マッチ度（0-1）
  instructions: string[];     // 指示内容プレビュー
}
```

### 3.4 API設計

```typescript
// 既存: AI提案取得
POST /api/ai/suggest
Request: { itemName, category }
Response: { expirationDays, storageMethod, servingMethods, notes }

// 新規: プリセット候補取得
POST /api/presets/suggest
Request: { residentId, itemName, category }
Response: { presets: PresetSuggestion[] }

// 新規: 統合提案取得（AI + プリセット）
POST /api/suggestions/unified
Request: { residentId, itemName, category }
Response: {
  ai: AISuggestResponse,
  presets: PresetSuggestion[],
  conflicts: ConflictInfo[]    // 矛盾検出結果
}
```

---

## 4. 実装優先度

### 高優先度（Phase 1）
1. [ ] プリセット取得API実装
2. [ ] PresetSelector.tsx 新規作成
3. [ ] AISuggestion.tsx にプリセットセクション追加
4. [ ] ItemForm.tsx 統合

### 中優先度（Phase 2）
5. [ ] 統合提案API実装
6. [ ] 矛盾検出ロジック
7. [ ] 指示出所トラッキング

### 低優先度（Phase 3）
8. [ ] 品物登録からプリセット作成
9. [ ] パターン自動検出
10. [ ] プリセット提案機能

---

## 5. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| 既存ユーザーの混乱 | 中 | 段階的リリース、ヘルプ追加 |
| データ移行 | 低 | 新フィールドはオプショナル |
| パフォーマンス | 低 | プリセットはキャッシュ活用 |
| 矛盾検出の複雑化 | 中 | 初期は警告のみ、強制なし |

---

## 6. 結論・推奨

### 複眼チェック総合評価

| 視点 | 現状維持 | 統合案 | 判定 |
|------|----------|--------|------|
| UXデザイナー | △ 分散で認知負荷 | ◎ ワンストップ | 統合推奨 |
| バックエンド | ○ シンプル | ○ 参照型で影響小 | どちらも可 |
| PM | △ 機能活用率低 | ◎ 価値向上 | 統合推奨 |
| フロントエンド | ○ 現状維持容易 | ○ 2-3日で実装可能 | 統合推奨 |
| QA | ○ テスト範囲明確 | △ エッジケース増 | 要注意 |

### 最終推奨

**Phase 1 の段階的統合を推奨**

理由:
1. ユーザー価値が明確に向上（ワンストップ設定）
2. 実装コストが比較的低い（2-3日）
3. 既存システムへの影響が最小限
4. 将来の拡張性を確保

次のステップ:
1. 本ドキュメントのレビュー・承認
2. AI_INTEGRATION_SPEC.md へのセクション追加
3. Phase 1 実装開始

---

## 変更履歴

| 日付 | 変更内容 | 担当 |
|------|----------|------|
| 2025-12-16 | 初版作成 | Claude |
