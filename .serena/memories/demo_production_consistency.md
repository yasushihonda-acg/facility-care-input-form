# デモ・本番整合性ルール

## 問題発覚（2026-01-06）

デモと本番の機能整合性が取れていないことが発覚:
- デモツアーの説明が実装と乖離
- E2Eテストが存在するが実装がない機能（Phase 55）
- 削除された機能への参照が残っている

## CLAUDE.mdに追加したルール

セクション4「デモ・本番・ツアー整合性ルール」を新設:
- 設計原則（Mermaid図）
- ルート対照表（デモ ↔ 本番）15ルート
- ツアー ↔ 機能 対照表（9ステップ）
- 削除済み機能表（5機能）
- 機能変更時のチェックリスト

## Phase 55/58の経緯

### Phase 55: 品物操作通知（家族依頼）- デモ実装
- 2026-01-04: デモ版実装（PR #60, #61）
- **問題**: 本番モードでは空配列を返す「デモのみ実装」だった

### Phase 58: 品物操作通知 - 本番実装
- 2026-01-07: 本番実装完了
- **変更**: item_events API + Firestore連携
- **テスト**: `e2e/item-action-notifications.spec.ts`（有効化予定）
- **デモデータ**: `demoItemEvents.ts`（デモモードで使用）

## 削除済み機能

| 機能 | Phase | 理由 |
|------|-------|------|
| 入居者設定（禁止品目） | 26 | 運用で代替 |
| チャット機能 | 21 | 一時非表示 |
| タスク機能 | 56 | 品物管理で代替 |
| **品物操作通知（家族依頼タブ）** | 58 | Phase 58で本番実装完了（item_events API） |
| AI提案ボタン | 41 | 一時非表示 |

## 機能変更時のチェック

1. ルート対照表の確認
2. ツアー説明の更新
3. デモデータの追加/削除
4. E2Eテストの同期
5. 削除済み機能表の更新

## 2026-01-07 原因調査: 家族操作通知の本番実装漏れ

### 問題
StaffNotesPageの「家族依頼」タブが本番で空表示だった

### 原因
1. **Phase設計の不備**: デモ先行実装で本番対応を「将来」としコメントに記載→タスク化されず
2. **Phase 56の副作用**: タスク機能削除時に確認漏れ
3. **対照表の粒度不足**: ルート単位で追跡しており、内部機能は追跡外

### 再発防止策
1. `return []` + `isDemo` パターンを定期検索
2. Phase完了基準に「本番動作確認」を必須化
3. 対照表をデータソース単位で管理

### 修正内容（Phase 58）
- Backend: `functions/src/functions/itemEvents.ts` 新規追加
- Backend: `careItems.ts` に logItemEvent 呼び出し追加
- Frontend: `useItemEvents.ts` に useFamilyActionNotifications 追加
- Frontend: `StaffNotesPage.tsx` でフックを使用
