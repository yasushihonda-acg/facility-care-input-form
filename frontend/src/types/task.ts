/**
 * ã‚¿ã‚¹ã‚¯ç®¡ç† å‹å®šç¾©
 * @see docs/TASK_MANAGEMENT_SPEC.md
 */

// === åˆ—æŒ™å‹ ===

// ã‚¿ã‚¹ã‚¯ç¨®åˆ¥
export type TaskType =
  | 'expiration_warning'  // è³å‘³æœŸé™è­¦å‘Š
  | 'serve_reminder'      // æä¾›ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼
  | 'restock_alert'       // åœ¨åº«åˆ‡ã‚Œã‚¢ãƒ©ãƒ¼ãƒˆ
  | 'care_instruction'    // ã‚±ã‚¢æŒ‡ç¤ºç¢ºèª
  | 'custom';             // ã‚«ã‚¹ã‚¿ãƒ ã‚¿ã‚¹ã‚¯

export const TASK_TYPES: { value: TaskType; label: string; icon: string }[] = [
  { value: 'expiration_warning', label: 'è³å‘³æœŸé™', icon: 'â°' },
  { value: 'serve_reminder', label: 'æä¾›äºˆå®š', icon: 'ğŸ½ï¸' },
  { value: 'restock_alert', label: 'åœ¨åº«åˆ‡ã‚Œ', icon: 'ğŸ“¦' },
  { value: 'care_instruction', label: 'ã‚±ã‚¢æŒ‡ç¤º', icon: 'ğŸ“‹' },
  { value: 'custom', label: 'ãã®ä»–', icon: 'ğŸ“' },
];

// ã‚¿ã‚¹ã‚¯ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
export type TaskStatus =
  | 'pending'      // æœªç€æ‰‹
  | 'in_progress'  // å¯¾å¿œä¸­
  | 'completed'    // å®Œäº†
  | 'cancelled';   // ã‚­ãƒ£ãƒ³ã‚»ãƒ«

export const TASK_STATUSES: { value: TaskStatus; label: string; color: string; bgColor: string }[] = [
  { value: 'pending', label: 'æœªç€æ‰‹', color: 'text-yellow-700', bgColor: 'bg-yellow-100' },
  { value: 'in_progress', label: 'å¯¾å¿œä¸­', color: 'text-blue-700', bgColor: 'bg-blue-100' },
  { value: 'completed', label: 'å®Œäº†', color: 'text-green-700', bgColor: 'bg-green-100' },
  { value: 'cancelled', label: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', color: 'text-gray-700', bgColor: 'bg-gray-100' },
];

// å„ªå…ˆåº¦
export type TaskPriority =
  | 'low'     // ä½
  | 'medium'  // ä¸­
  | 'high'    // é«˜
  | 'urgent'; // ç·Šæ€¥

export const TASK_PRIORITIES: { value: TaskPriority; label: string; color: string; bgColor: string; order: number }[] = [
  { value: 'urgent', label: 'ç·Šæ€¥', color: 'text-red-700', bgColor: 'bg-red-100', order: 0 },
  { value: 'high', label: 'é«˜', color: 'text-orange-700', bgColor: 'bg-orange-100', order: 1 },
  { value: 'medium', label: 'ä¸­', color: 'text-yellow-700', bgColor: 'bg-yellow-100', order: 2 },
  { value: 'low', label: 'ä½', color: 'text-gray-700', bgColor: 'bg-gray-100', order: 3 },
];

// === ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ ===

// ã‚¿ã‚¹ã‚¯ï¼ˆFirestore: tasks/{taskId}ï¼‰
export interface Task {
  // è­˜åˆ¥æƒ…å ±
  id: string;
  residentId: string;

  // ã‚¿ã‚¹ã‚¯å†…å®¹
  title: string;
  description?: string;
  taskType: TaskType;

  // é–¢é€£ãƒ‡ãƒ¼ã‚¿
  relatedItemId?: string;        // é–¢é€£ã™ã‚‹å“ç‰©IDï¼ˆcare_itemsï¼‰
  relatedInstructionId?: string; // é–¢é€£ã™ã‚‹ã‚±ã‚¢æŒ‡ç¤ºIDï¼ˆcare_instructionsï¼‰

  // ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
  dueDate: string;               // YYYY-MM-DD
  dueTime?: string;              // HH:mm

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ»å„ªå…ˆåº¦
  status: TaskStatus;
  priority: TaskPriority;

  // æ‹…å½“ãƒ»å®Ÿè¡Œ
  assignee?: string;             // æ‹…å½“è€…ï¼ˆã‚¹ã‚¿ãƒƒãƒ•åï¼‰
  completedBy?: string;          // å®Œäº†è€…ï¼ˆã‚¹ã‚¿ãƒƒãƒ•åï¼‰
  completionNote?: string;       // å®Œäº†æ™‚ã®ãƒ¡ãƒ¢

  // é€šçŸ¥
  notificationSent: boolean;

  // ç”Ÿæˆæƒ…å ±
  createdBy?: string;            // 'system' or ã‚¹ã‚¿ãƒƒãƒ•å
  isAutoGenerated: boolean;

  // ãƒ¡ã‚¿æƒ…å ±
  createdAt: string;             // ISO8601
  updatedAt: string;             // ISO8601
  completedAt?: string;          // ISO8601
}

// === APIãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‹ ===

// ã‚¿ã‚¹ã‚¯ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ
export interface CreateTaskInput {
  residentId: string;
  title: string;
  description?: string;
  taskType?: TaskType;           // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 'custom'
  dueDate: string;
  dueTime?: string;
  priority: TaskPriority;
  assignee?: string;
  relatedItemId?: string;
  relatedInstructionId?: string;
}

// ã‚¿ã‚¹ã‚¯æ›´æ–°ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
export interface UpdateTaskInput {
  status?: TaskStatus;
  assignee?: string;
  completionNote?: string;
  completedBy?: string;
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§å–å¾—ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿
export interface GetTasksParams {
  residentId?: string;
  status?: TaskStatus | TaskStatus[];
  taskType?: TaskType;
  priority?: TaskPriority;
  dueDate?: string;
  dueDateStart?: string;
  dueDateEnd?: string;
  limit?: number;
  offset?: number;
  sortBy?: 'dueDate' | 'priority' | 'createdAt';
  sortOrder?: 'asc' | 'desc';
}

// ã‚¿ã‚¹ã‚¯ä¸€è¦§ãƒ¬ã‚¹ãƒãƒ³ã‚¹
export interface GetTasksResponse {
  tasks: Task[];
  total: number;
  counts: TaskCounts;
}

// ã‚¿ã‚¹ã‚¯ä»¶æ•°
export interface TaskCounts {
  pending: number;
  inProgress: number;
  completed: number;
  overdue: number;
}

// ã‚¿ã‚¹ã‚¯ä½œæˆãƒ¬ã‚¹ãƒãƒ³ã‚¹
export interface CreateTaskResponse {
  taskId: string;
  createdAt: string;
}

// ã‚¿ã‚¹ã‚¯æ›´æ–°ãƒ¬ã‚¹ãƒãƒ³ã‚¹
export interface UpdateTaskResponse {
  taskId: string;
  status: TaskStatus;
  updatedAt: string;
}

// === ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•° ===

/**
 * ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
 */
export function getTaskTypeLabel(taskType: TaskType): string {
  return TASK_TYPES.find(t => t.value === taskType)?.label ?? taskType;
}

/**
 * ã‚¿ã‚¹ã‚¯ç¨®åˆ¥ã®ã‚¢ã‚¤ã‚³ãƒ³ã‚’å–å¾—
 */
export function getTaskTypeIcon(taskType: TaskType): string {
  return TASK_TYPES.find(t => t.value === taskType)?.icon ?? 'ğŸ“';
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
 */
export function getTaskStatusLabel(status: TaskStatus): string {
  return TASK_STATUSES.find(s => s.value === status)?.label ?? status;
}

/**
 * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®è‰²ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
 */
export function getTaskStatusColorClass(status: TaskStatus): { color: string; bgColor: string } {
  const statusConfig = TASK_STATUSES.find(s => s.value === status);
  return {
    color: statusConfig?.color ?? 'text-gray-700',
    bgColor: statusConfig?.bgColor ?? 'bg-gray-100',
  };
}

/**
 * å„ªå…ˆåº¦ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
 */
export function getTaskPriorityLabel(priority: TaskPriority): string {
  return TASK_PRIORITIES.find(p => p.value === priority)?.label ?? priority;
}

/**
 * å„ªå…ˆåº¦ã®è‰²ã‚¯ãƒ©ã‚¹ã‚’å–å¾—
 */
export function getTaskPriorityColorClass(priority: TaskPriority): { color: string; bgColor: string } {
  const priorityConfig = TASK_PRIORITIES.find(p => p.value === priority);
  return {
    color: priorityConfig?.color ?? 'text-gray-700',
    bgColor: priorityConfig?.bgColor ?? 'bg-gray-100',
  };
}

/**
 * å„ªå…ˆåº¦ã§ã‚½ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã®é †åºã‚’å–å¾—
 */
export function getTaskPriorityOrder(priority: TaskPriority): number {
  return TASK_PRIORITIES.find(p => p.value === priority)?.order ?? 99;
}

/**
 * ã‚¿ã‚¹ã‚¯ãŒæœŸé™åˆ‡ã‚Œã‹ã©ã†ã‹ã‚’åˆ¤å®š
 */
export function isTaskOverdue(task: Task): boolean {
  if (task.status === 'completed' || task.status === 'cancelled') {
    return false;
  }
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const dueDate = new Date(task.dueDate);
  dueDate.setHours(0, 0, 0, 0);
  return dueDate < today;
}

/**
 * æœŸé™ã¾ã§ã®æ—¥æ•°ã‚’è¨ˆç®—
 */
export function getDaysUntilDue(dueDate: string): number {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const due = new Date(dueDate);
  due.setHours(0, 0, 0, 0);
  const diffTime = due.getTime() - today.getTime();
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
}

/**
 * æœŸé™ã®è¡¨ç¤ºãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
 */
export function getDueDateDisplayText(dueDate: string): string {
  const days = getDaysUntilDue(dueDate);
  if (days < 0) {
    return `${Math.abs(days)}æ—¥å‰`;
  } else if (days === 0) {
    return 'ä»Šæ—¥';
  } else if (days === 1) {
    return 'æ˜æ—¥';
  } else if (days <= 7) {
    return `${days}æ—¥å¾Œ`;
  } else {
    return formatTaskDate(dueDate);
  }
}

/**
 * æ—¥ä»˜ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMM/DDå½¢å¼ï¼‰
 */
export function formatTaskDate(dateStr: string): string {
  if (!dateStr) return '';
  const date = new Date(dateStr);
  const m = date.getMonth() + 1;
  const d = date.getDate();
  return `${m}/${d}`;
}

/**
 * æ—¥æ™‚ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆMM/DD HH:mmå½¢å¼ï¼‰
 */
export function formatTaskDateTime(dateStr: string, timeStr?: string): string {
  const date = formatTaskDate(dateStr);
  if (timeStr) {
    return `${date} ${timeStr}`;
  }
  return date;
}
