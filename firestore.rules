rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    /**
     * Phase 52: Firebase Authentication + 許可リストによるアクセス制御
     *
     * 許可条件:
     * - @aozora-cg.com ドメインのユーザー
     * - allowed_emails/{email_key} に登録されたユーザー
     *
     * 許可リスト構造:
     * allowed_domains/{domain}: { allowed: true }
     * allowed_emails/{email_key}: { allowed: true }
     *
     * ※ email_key はメールアドレスの "." を "_" に置換した文字列
     */

    // 許可されたユーザーかどうかをチェック
    function isAllowedUser() {
      let email = request.auth.token.email;
      let domain = email.split('@')[1];

      // ドメインが許可されているかチェック
      let domainAllowed = exists(/databases/$(database)/documents/allowed_domains/$(domain));

      // 個別メールが許可されているかチェック
      // Firestoreはドキュメント名に "." を含められないため、"_" に置換
      // replace()は最初のマッチのみ置換するため、複数回呼び出して最大5つの"."に対応
      let emailKey = email.replace('.', '_').replace('.', '_').replace('.', '_').replace('.', '_').replace('.', '_');
      let emailAllowed = exists(/databases/$(database)/documents/allowed_emails/$(emailKey));

      return domainAllowed || emailAllowed;
    }

    // 認証済み + 許可リストに含まれるユーザーのみアクセス可能
    function isAuthorized() {
      return request.auth != null && isAllowedUser();
    }

    // 許可リストは常に読み取り可能（認証チェック時に必要）
    match /allowed_domains/{domain} {
      allow read: if request.auth != null;
      allow write: if false; // 管理者のみ（CLIから操作）
    }

    match /allowed_emails/{emailKey} {
      allow read: if request.auth != null;
      allow write: if false; // 管理者のみ（CLIから操作）
    }

    // 設定は認証済みユーザーのみ
    match /settings/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAuthorized();
    }

    // その他のコレクション
    match /{collection}/{document=**} {
      allow read, write: if isAuthorized();
    }
  }
}
